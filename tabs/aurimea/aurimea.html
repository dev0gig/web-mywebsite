<!DOCTYPE html>
<html lang="de" class="h-full" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuriMea - Interaktives Finanz-Dashboard</title>
    <!-- Einbindung von Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Einbindung von Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Einbindung von Lucide Icons für den Kalender -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Farben-Schema für Konsistenz */
        :root {
            --bg-color: #f9fafb;
            --text-color: #111827;
            --text-color-light: #6b7280;
            --header-color: #111827;
            --card-bg: #ffffff;
            --card-text: #111827;
            --subtle-text: #6b7280;
            --border-color: #e5e7eb;
            --edit-btn-hover-bg: #3b82f6;
            /* blue-600 */
        }

        html[data-theme='dark'] {
            --bg-color: #171717;
            --text-color: #fafafa;
            --text-color-light: #a3a3a3;
            --header-color: #fafafa;
            --card-bg: #262626;
            --card-text: #fafafa;
            --subtle-text: #a3a3a3;
            --border-color: #404040;
            --edit-btn-hover-bg: #2563eb;
            /* blue-700 */
        }

        html {
            /* Verhindert das "Springen" der Seite, wenn der Scrollbalken erscheint/verschwindet */
            scrollbar-gutter: stable;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            /* Fügt unten Platz hinzu, um zu verhindern, dass die schwebenden Buttons Inhalte überdecken,
               insbesondere auf Mobilgeräten. env(safe-area-inset-bottom) berücksichtigt die Home-Leiste auf iOS. */
            padding-bottom: 8rem;
        }

        @media (min-width: 1024px) {
            body {
                /* Setzt Padding für Desktop zurück, da die Buttons hier nicht schweben */
                padding-bottom: 1.5rem;
                /* Entspricht p-6 von Tailwind */
            }
        }

        /* --- Benutzerdefinierte Scrollbar-Stile --- */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 10px;
            border: 3px solid var(--bg-color);
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--subtle-text);
        }

        .main-title {
            color: var(--header-color);
        }

        .card {
            background-color: var(--card-bg);
            color: var(--card-text);
            border: 1px solid var(--border-color);
        }

        .subtle-text {
            color: var(--subtle-text);
        }

        .filter-btn {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--subtle-text);
            transition: background-color 0.2s, color 0.2s, border-color 0.2s; /* Übergänge für Farben und Rahmen */
        }

        .filter-btn:hover {
            background-color: var(--border-color);
        }

        /* --- STILE FÜR AKTUELLE FILTER-BUTTONS (AKTIV-ZUSTAND) --- */
        .filter-btn.active {
            color: white; /* Textfarbe auf Weiß für alle aktiven Buttons */
            border-color: transparent; /* Setze Standard-Rahmen auf transparent, Farben werden spezifisch gesetzt */
        }

        .filter-btn.active[data-filter="all"] {
            background-color: #9333ea; /* Tailwind violet-600 */
            border-color: #9333ea;
        }
        .filter-btn.active[data-filter="all"]:hover {
            background-color: #7c2d12; /* Dunklerer Violett-Ton für Hover */
            border-color: #7c2d12;
        }

        .filter-btn.active[data-filter="Erste Bank"] {
            background-color: #2563eb; /* Tailwind blue-600 */
            border-color: #2563eb;
        }
        .filter-btn.active[data-filter="Erste Bank"]:hover {
            background-color: #1d4ed8; /* Dunklerer Blau-Ton für Hover */
            border-color: #1d4ed8;
        }

        .filter-btn.active[data-filter="N26"] {
            background-color: #14b8a6; /* Tailwind teal-500 (Türkis) */
            border-color: #14b8a6;
        }
        .filter-btn.active[data-filter="N26"]:hover {
            background-color: #0d9488; /* Dunklerer Türkis-Ton für Hover */
            border-color: #0d9488;
        }

        .filter-btn.active[data-filter="Revolut"] {
            background-color: #9ca3af; /* Tailwind gray-400 (Silber) */
            border-color: #9ca3af;
        }
        .filter-btn.active[data-filter="Revolut"]:hover {
            background-color: #6b7280; /* Dunklerer Grau-Ton für Hover */
            border-color: #6b7280;
        }
        /* --- ENDE STILE FÜR AKTUELLE FILTER-BUTTONS --- */


        .table-header-sortable:hover {
            background-color: var(--border-color);
            cursor: pointer;
        }

        /* --- NEUE KALENDER-STILE (adaptiert von MemoMea) --- */
        .calendar-day {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            margin: auto;
            position: relative;
            border: none;
            background-color: transparent;
        }

        .calendar-day:hover {
            background-color: var(--border-color);
        }

        .calendar-day.has-transactions::after {
            content: '';
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background-color: #4f46e5;
            /* Indigo */
        }

        html[data-theme='dark'] .calendar-day.has-transactions::after {
            background-color: #818cf8;
            /* Indigo-400 */
        }

        .calendar-day.today {
            background-color: #dbeafe;
            /* blue-100 */
            color: #1e40af;
            /* blue-800 */
            font-weight: 700;
        }

        html[data-theme='dark'] .calendar-day.today {
            background-color: #1e3a8a;
            /* blue-900 */
            color: #eff6ff;
            /* blue-50 */
        }

        .calendar-day.selected {
            background-color: #4f46e5;
            color: white;
            font-weight: 700;
            box-shadow: none;
        }

        .calendar-day.selected:hover {
            background-color: #4338ca;
        }

        .calendar-day.selected.has-transactions::after {
            background-color: white;
        }

        /* --- ENDE NEUE KALENDER-STILE --- */

        /* Stile für Aktions-Buttons */
        .action-btn {
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            color: var(--subtle-text);
            transition: background-color 0.2s, color 0.2s;
        }

        .delete-btn:hover {
            background-color: #ef4444;
            color: white;
        }

        .edit-btn:hover {
            background-color: var(--edit-btn-hover-bg);
            color: white;
        }

        /* Stile für Benachrichtigungen */
        #notification {
            transition: opacity 0.3s, transform 0.3s;
        }

        #notification.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* Positionierung der schwebenden Aktionsbuttons unter Berücksichtigung der Safe Area */
        #fab-open-calendar {
            bottom: calc(6rem + env(safe-area-inset-bottom));
        }

        #fab-add-transaction {
            bottom: calc(1.5rem + env(safe-area-inset-bottom));
        }
    </style>
</head>

<body class="p-4 md:p-6">
    <h1 class="text-3xl md:text-4xl font-bold main-title mb-6 text-center">AuriMea</h1>

    <!-- HAUPTINHALTSBEREICH -->
    <div class="w-full mx-auto flex flex-col gap-6 px-4 md:px-6">

        <!-- 1. ZEILE: KONTEN & KENNZAHLEN -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Konten-Filter -->
            <div class="card p-4 rounded-xl shadow-md flex flex-col justify-center">
                <!-- Geändert: 'grid grid-cols-2' um 2 Spalten zu erzwingen, was zu 2 Reihen führt -->
                <div id="account-filter" class="grid grid-cols-2 gap-2">
                    <!-- 'flex-grow' entfernt, da 'grid' die Breitenverteilung übernimmt -->
                    <button data-filter="all"
                        class="filter-btn active px-4 py-2 rounded-lg font-semibold transition">Alle
                        Konten</button>
                    <button data-filter="Erste Bank"
                        class="filter-btn px-4 py-2 rounded-lg font-semibold transition">Erste Bank</button>
                    <button data-filter="N26"
                        class="filter-btn px-4 py-2 rounded-lg font-semibold transition">N26</button>
                    <button data-filter="Revolut"
                        class="filter-btn px-4 py-2 rounded-lg font-semibold transition">Revolut</button>
                </div>
            </div>
            <!-- Einnahmen -->
            <div class="card p-4 md:p-6 rounded-xl shadow-md text-center flex flex-col justify-center h-full">
                <h2 class="text-lg font-semibold subtle-text">Einnahmen</h2>
                <p id="total-einnahmen" class="text-2xl font-bold text-green-500">0,00 €</p>
            </div>
            <!-- Ausgaben -->
            <div class="card p-4 md:p-6 rounded-xl shadow-md text-center flex flex-col justify-center h-full">
                <h2 class="text-lg font-semibold subtle-text">Ausgaben</h2>
                <p id="total-ausgaben" class="text-2xl font-bold text-red-500">0,00 €</p>
            </div>
            <!-- Bilanz -->
            <div class="card p-4 md:p-6 rounded-xl shadow-md text-center flex flex-col justify-center h-full">
                <h2 class="text-lg font-semibold subtle-text">Bilanz</h2>
                <p id="bilanz" class="text-2xl font-bold">0,00 €</p>
            </div>
        </div>

        <!-- 2. ZEILE: KALENDER & DIAGRAMME -->
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- Ausgaben nach Kategorie -->
            <div class="card w-full p-4 md:p-6 rounded-xl shadow-md flex flex-col h-full">
                <h2 class="text-xl font-bold text-center mb-4">Ausgaben nach Kategorie</h2>
                <div class="relative flex-grow h-64"><canvas id="ausgabenChart"></canvas></div>
            </div>
            <!-- Einnahmen nach Kategorie -->
            <div class="card w-full p-4 md:p-6 rounded-xl shadow-md flex flex-col h-full">
                <h2 class="text-xl font-bold text-center mb-4">Einnahmen nach Kategorie</h2>
                <div class="relative flex-grow h-64"><canvas id="einnahmenChart"></canvas></div>
            </div>
            <!-- Ausgaben pro Konto -->
            <div class="card w-full p-4 md:p-6 rounded-xl shadow-md flex flex-col h-full">
                <h2 class="text-xl font-bold text-center mb-4">Ausgaben pro Konto</h2>
                <div class="relative flex-grow h-64"><canvas id="kontoChart"></canvas></div>
            </div>
            <!-- Kalender (wird auf lg-Screens an den Anfang verschoben) -->
            <div id="calendar-desktop-wrapper"
                class="card p-4 md:p-6 rounded-xl shadow-md hidden lg:flex flex-col h-full lg:order-first">
                <div id="calendar-container-desktop" class="flex flex-col w-full h-full">
                    <div id="calendar-header-desktop" class="flex justify-between items-center mb-4 w-full">
                        <!-- Inhalt wird durch JS generiert -->
                    </div>
                    <div id="calendar-grid-desktop" class="grid grid-cols-7 gap-1 text-center flex-grow">
                        <!-- Inhalt wird durch JS generiert -->
                    </div>
                </div>
                <div class="text-center mt-4 w-full min-h-[40px]">
                    <button id="clear-date-filter-btn-desktop"
                        class="filter-btn hidden px-4 py-2 rounded-lg font-semibold transition">Datumsfilter
                        zurücksetzen</button>
                </div>
            </div>
        </div>

        <!-- 3. ZEILE: TRANSAKTIONSTABELLE -->
        <div class="w-full card p-4 md:p-6 rounded-xl shadow-md overflow-x-auto">
            <div class="flex justify-between items-center flex-wrap gap-4 mb-4">
                <div class="flex items-center gap-2 flex-wrap">
                    <h2 class="text-xl font-bold">Transaktionen</h2>
                    <button id="add-transaction-btn" title="Neue Transaktion hinzufügen"
                        class="filter-btn p-2 rounded-md font-semibold transition text-sm flex items-center gap-2"><svg
                            xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                                clip-rule="evenodd" />
                        </svg><span>Neu</span></button>
                    <button id="import-csv-btn" title="Transaktionen aus CSV-Datei importieren"
                        class="filter-btn p-2 rounded-md font-semibold transition text-sm flex items-center gap-2"><svg
                            xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 8.25H7.5a2.25 2.25 0 0 0-2.25 2.25v9a2.25 2.25 0 0 0 2.25 2.25h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25H15m0-3-3-3m0 0-3 3m3-3v11.25" />
                        </svg><span>Importieren</span></button>
                    <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                    <button id="export-csv-btn" title="Alle Transaktionen als CSV-Datei exportieren"
                        class="filter-btn p-2 rounded-md font-semibold transition text-sm flex items-center gap-2"><svg
                            xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg><span>Exportieren</span></button>
                    <button id="delete-all-transactions-btn" title="Alle Transaktionen löschen"
                        class="filter-btn p-2 rounded-md font-semibold transition bg-red-500 hover:bg-red-600 text-white flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.927a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.679-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.14-2.006-2.293a1.5 1.5 0 00-1.482 0L9.5 3.251A2.25 2.25 0 007.25 2.25h-.916c-1.18 0-2.14.91-2.293 2.006a1.5 1.5 0 000 1.482l.916.293m7.5 0a48.667 48.667 0 00-7.5 0" />
                        </svg>
                    </button>
                </div>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><svg
                            class="w-5 h-5" style="color: var(--subtle-text);" xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                        </svg></span>
                    <input type="text" id="transaction-search-input" placeholder="Transaktionen durchsuchen..."
                        class="w-full md:w-72 pl-10 pr-10 py-2 rounded-lg"
                        style="background-color: var(--bg-color); border: 1px solid var(--border-color);">
                    <button id="clear-search-btn"
                        class="hidden absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer"><svg
                            class="w-5 h-5" style="color: var(--subtle-text);" xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg></button>
                </div>
            </div>
            <table class="w-full text-left min-w-[600px]">
                <thead>
                    <tr class="border-b" style="border-color: var(--border-color);">
                        <th class="p-2 table-header-sortable" data-sort="Datum">Datum</th>
                        <th class="p-2 table-header-sortable" data-sort="Art">Art</th>
                        <th class="p-2 table-header-sortable" data-sort="Betrag">Betrag</th>
                        <th class="p-2 table-header-sortable" data-sort="Beschreibung">Beschreibung</th>
                        <th class="p-2 table-header-sortable" data-sort="Kategorie">Kategorie</th>
                        <th class="p-2 table-header-sortable" data-sort="Konto">Konto</th>
                        <th class="p-2">Zahlungsmethode</th>
                        <th class="p-2 table-header-sortable" data-sort="Wiederkehrend">Wiederkehrend</th>
                        <th class="p-2">Sonstige Infos</th>
                        <th class="p-2 text-center">Aktionen</th>
                    </tr>
                </thead>
                <tbody id="transaction-table-body"></tbody>
            </table>
            <div id="pagination-controls" class="flex justify-between items-center mt-4 pt-4 border-t"
                style="border-color: var(--border-color);"></div>
        </div>
    </div>

    <!-- Modal zum Hinzufügen/Bearbeiten einer Transaktion -->
    <div id="transaction-modal-overlay"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-40 opacity-0 pointer-events-none transition-opacity duration-300">
    </div>
    <div id="transaction-modal"
        class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-lg z-50 opacity-0 pointer-events-none scale-95 transition-all duration-300">
        <div class="card p-6 rounded-xl shadow-lg max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold">Neue Transaktion</h2>
                <button id="close-modal-btn"
                    class="w-8 h-8 flex items-center justify-center rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 transition"><svg
                        class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg></button>
            </div>
            <form id="transaction-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="trans-datum" class="block text-sm font-medium subtle-text mb-1">Datum</label><input
                            type="date" id="trans-datum" required class="w-full p-2 rounded-lg"
                            style="background-color: var(--bg-color); border: 1px solid var(--border-color);"></div>
                    <div><label for="trans-art" class="block text-sm font-medium subtle-text mb-1">Art</label><select
                            id="trans-art" required class="w-full p-2 rounded-lg"
                            style="background-color: var(--bg-color); border: 1px solid var(--border-color);">
                            <option value="Ausgabe">Ausgabe</option>
                            <option value="Einnahme">Einnahme</option>
                        </select></div>
                    <div class="md:col-span-2"><label for="trans-betrag"
                            class="block text-sm font-medium subtle-text mb-1">Betrag (€)</label><input type="number"
                            id="trans-betrag" step="0.01" required placeholder="z.B. 19.99"
                            class="w-full p-2 rounded-lg"
                            style="background-color: var(--bg-color); border: 1px solid var(--border-color);"></div>
                    <div class="md:col-span-2"><label for="trans-beschreibung"
                            class="block text-sm font-medium subtle-text mb-1">Beschreibung</label><input type="text"
                            id="trans-beschreibung" required placeholder="z.B. Wocheneinkauf"
                            class="w-full p-2 rounded-lg"
                            style="background-color: var(--bg-color); border: 1px solid var(--border-color);"></div>
                    <div><label for="trans-kategorie"
                            class="block text-sm font-medium subtle-text mb-1">Kategorie</label><select
                            id="trans-kategorie" required class="w-full p-2 rounded-lg"
                            style="background-color: var(--bg-color); border: 1px solid var(--border-color);"></select>
                    </div>
                    <div><label for="trans-konto"
                            class="block text-sm font-medium subtle-text mb-1">Konto</label><select id="trans-konto"
                            required class="w-full p-2 rounded-lg transition-opacity"
                            style="background-color: var(--bg-color); border: 1px solid var(--border-color);">
                            <option>Erste Bank</option>
                            <option>N26</option>
                            <option>Revolut</option>
                        </select></div>
                    <div class="md:col-span-2 grid grid-cols-2 gap-4 items-end">
                        <div>
                            <label class="block text-sm font-medium subtle-text mb-1">Zahlungsmethode</label>
                            <div class="flex items-center gap-x-4 mt-2">
                                <div class="flex items-center">
                                    <input id="trans-zahlungsmethode-karte" name="trans-zahlungsmethode" type="radio"
                                        value="Karte" checked class="h-4 w-4"
                                        style="border-color: var(--border-color);">
                                    <label for="trans-zahlungsmethode-karte"
                                        class="ml-2 block text-sm font-medium">Karte</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="trans-zahlungsmethode-bar" name="trans-zahlungsmethode" type="radio"
                                        value="Bar" class="h-4 w-4" style="border-color: var(--border-color);">
                                    <label for="trans-zahlungsmethode-bar"
                                        class="ml-2 block text-sm font-medium">Bar</label>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 pb-1">
                            <input type="checkbox" id="trans-wiederkehrend" class="h-4 w-4 rounded"
                                style="border-color: var(--border-color);"><label for="trans-wiederkehrend"
                                class="text-sm font-medium">Wiederkehrend</label>
                        </div>
                    </div>
                    <div class="md:col-span-2"><label for="trans-sonstige-infos"
                            class="block text-sm font-medium subtle-text mb-1">Sonstige Infos</label><textarea
                            id="trans-sonstige-infos" rows="2" placeholder="Zusätzliche Notizen..."
                            class="w-full p-2 rounded-lg"
                            style="background-color: var(--bg-color); border: 1px solid var(--border-color);"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end"><button type="submit"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bestätigungs-Modal -->
    <div id="confirm-modal-overlay"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-40 opacity-0 pointer-events-none transition-opacity duration-300">
    </div>
    <div id="confirm-modal"
        class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-md z-50 opacity-0 pointer-events-none scale-95 transition-all duration-300">
        <div class="card p-6 rounded-xl shadow-lg">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4">Aktion bestätigen</h3>
            <p id="confirm-modal-text" class="mb-6">Möchten Sie diese Aktion wirklich ausführen?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel-btn"
                    class="filter-btn px-4 py-2 rounded-lg font-semibold transition">Abbrechen</button>
                <button id="confirm-modal-confirm-btn"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">Löschen</button>
            </div>
        </div>
    </div>

    <!-- Benachrichtigungs-Element -->
    <div id="notification"
        class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 pointer-events-none transition-all duration-300 -translate-y-12">
        <p id="notification-message"></p>
    </div>

    <!-- Kalender Seitenleiste (Mobile) -->
    <div id="calendar-sidebar-overlay"
        class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-40 opacity-0 pointer-events-none transition-opacity duration-300 lg:hidden">
    </div>
    <div id="calendar-sidebar"
        class="fixed top-0 right-0 h-full w-full max-w-sm shadow-xl z-50 transform translate-x-full transition-transform duration-300 lg:hidden"
        style="background-color: var(--card-bg);">
        <div class="p-4 md:p-6 flex flex-col h-full">
            <div class="flex justify-between items-center mb-4 w-full flex-shrink-0">
                <h3 class="text-xl font-bold" style="color: var(--text-color);">Kalender</h3>
                <button id="close-calendar-sidebar-btn"
                    class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="calendar-header-mobile" class="flex justify-between items-center mb-4 w-full flex-shrink-0"></div>
            <div id="calendar-grid-mobile" class="grid grid-cols-7 gap-1 text-center flex-grow"></div>
            <div class="text-center mt-4 w-full min-h-[40px] flex-shrink-0">
                <button id="clear-date-filter-btn-mobile"
                    class="filter-btn hidden px-4 py-2 rounded-lg font-semibold transition">Datumsfilter
                    zurücksetzen</button>
            </div>
        </div>
    </div>

    <!-- Schwebende Aktionsbuttons -->
    <button id="fab-open-calendar" title="Kalender anzeigen"
        class="lg:hidden fixed right-6 bg-purple-600 hover:bg-purple-700 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg z-30 transition-transform transform hover:scale-110 active:scale-100">
        <i data-lucide="calendar" class="h-7 w-7"></i>
    </button>
    <button id="fab-add-transaction" title="Neue Transaktion hinzufügen"
        class="fixed right-6 bg-indigo-600 hover:bg-indigo-700 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg z-30 transition-transform transform hover:scale-110 active:scale-100">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
    </button>


    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT & KATEGORIEN ---
            let allTransactions = [];
            let searchTerm = '';
            let currentFilter = 'all';
            let selectedDate = null;
            let calendarDate = new Date();
            let sortConfig = {
                key: 'Datum',
                direction: 'desc'
            };
            let charts = {
                ausgaben: null,
                einnahmen: null,
                konto: null
            };
            let transactionDates = new Set();
            let currentPage = 1;
            const itemsPerPage = 25;
            const formatCurrency = (value) => new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR'
            }).format(value);
            const STORAGE_KEY = 'aurimea-transactions';
            const expenseCategories = ['Lebensmittel', 'Wohnen', 'Transport', 'Freizeit', 'Gesundheit', 'Kleidung', 'Rechnungen', 'Sonstiges'];
            const incomeCategories = ['Gehalt', 'Bonus', 'Geschenk', 'Verkauf', 'Sonstiges'];


            // --- MODAL & NOTIFICATION ELEMENTS ---
            const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmModalTitle = document.getElementById('confirm-modal-title');
            const confirmModalText = document.getElementById('confirm-modal-text');
            const confirmCancelBtn = document.getElementById('confirm-modal-cancel-btn');
            const confirmConfirmBtn = document.getElementById('confirm-modal-confirm-btn');
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            let confirmCallback = null;


            // --- DATA HANDLING ---
            function loadTransactions() {
                const storedTransactions = localStorage.getItem(STORAGE_KEY);
                try {
                    allTransactions = storedTransactions ? JSON.parse(storedTransactions) : [];
                    allTransactions.forEach(t => {
                        if (!t.id) {
                            t.id = crypto.randomUUID();
                        }
                    });
                    saveTransactions();
                } catch (e) {
                    console.error("Fehler beim Laden der Transaktionen:", e);
                    allTransactions = [];
                }
                transactionDates = new Set(allTransactions.map(t => t.parsedDate).filter(d => d && d.length === 10));
            }

            function saveTransactions() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allTransactions));
            }

            // --- MAIN UPDATE FUNCTION ---
            function updateDashboard() {
                const accountFilteredData = (currentFilter === 'all') ? allTransactions : allTransactions.filter(row => row.Konto === currentFilter);
                const financialSummary = processData(accountFilteredData);
                updateSummaryCards(financialSummary);
                createOrUpdateCharts(financialSummary);
                let tableData = [...accountFilteredData];
                if (selectedDate) {
                    tableData = tableData.filter(row => row.parsedDate === selectedDate);
                }
                if (searchTerm) {
                    const lowerCaseSearchTerm = searchTerm.toLowerCase();
                    tableData = tableData.filter(row => {
                        const displayKategorie = (row.Wiederkehrend === 'Ja' ? 'fixkosten' : (row.Kategorie || '')).toLowerCase();
                        const formattedBetrag = formatCurrency(row.Betrag).replace(/\./g, '').toLowerCase();
                        return Object.values(row).some(val => String(val).toLowerCase().includes(lowerCaseSearchTerm)) || displayKategorie.includes(lowerCaseSearchTerm) || formattedBetrag.includes(lowerCaseSearchTerm);
                    });
                }
                sortData(tableData);
                const paginatedData = tableData.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
                renderTransactionTable(paginatedData);
                renderPaginationControls(tableData.length);
            }

            // --- SORTING ---
            function sortData(data) {
                data.sort((a, b) => {
                    let aValue = a[sortConfig.key];
                    let bValue = b[sortConfig.key];
                    if (sortConfig.key === 'Datum') {
                        aValue = a.parsedDate;
                        bValue = b.parsedDate;
                    }
                    if (sortConfig.key === 'Betrag') {
                        aValue = a.Betrag;
                        bValue = b.Betrag;
                    }
                    if (aValue < bValue) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (aValue > bValue) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // --- DATA PROCESSING ---
            function processData(data) {
                const summary = {
                    ausgabenByCat: {},
                    einnahmenByCat: {},
                    ausgabenByKonto: {},
                    totalAusgaben: 0,
                    totalEinnahmen: 0
                };
                const kontoSummary = {};
                allTransactions.forEach(row => {
                    if (row.Art === 'Ausgabe' && row.Konto) {
                        kontoSummary[row.Konto] = (kontoSummary[row.Konto] || 0) + row.Betrag;
                    }
                });
                summary.ausgabenByKonto = kontoSummary;
                data.forEach(row => {
                    if (row.Art === 'Ausgabe') {
                        summary.ausgabenByCat[row.Kategorie] = (summary.ausgabenByCat[row.Kategorie] || 0) + row.Betrag;
                        summary.totalAusgaben += row.Betrag;
                    } else if (row.Art === 'Einnahme') {
                        summary.einnahmenByCat[row.Kategorie] = (summary.einnahmenByCat[row.Kategorie] || 0) + row.Betrag;
                        summary.totalEinnahmen += row.Betrag;
                    }
                });
                return summary;
            }

            // --- UI RENDERING ---
            function updateSummaryCards(summary) {
                const bilanz = summary.totalEinnahmen - summary.totalAusgaben;
                document.getElementById('total-einnahmen').textContent = formatCurrency(summary.totalEinnahmen);
                document.getElementById('total-ausgaben').textContent = formatCurrency(summary.totalAusgaben);
                const bilanzEl = document.getElementById('bilanz');
                bilanzEl.textContent = formatCurrency(bilanz);
                bilanzEl.className = `text-2xl font-bold ${bilanz >= 0 ? 'text-green-500' : 'text-red-500'}`;
            }

            function renderTransactionTable(data) {
                const tbody = document.getElementById('transaction-table-body');
                tbody.innerHTML = '';
                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="10" class="text-center p-4 subtle-text">Keine Transaktionen gefunden.</td></tr>`;
                    return;
                }
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b hover:bg-gray-50 dark:hover:bg-gray-800/50 text-sm';
                    tr.style.borderColor = 'var(--border-color)';
                    tr.innerHTML = `
                        <td class="p-2">${row.Datum || ''}</td>
                        <td class="p-2">${row.Art || ''}</td>
                        <td class="p-2 text-right ${row.Art === 'Einnahme' ? 'text-green-500' : 'text-red-500'}">${formatCurrency(row.Betrag)}</td>
                        <td class="p-2">${row.Beschreibung || ''}</td>
                        <td class="p-2">${row.Kategorie || ''}</td>
                        <td class="p-2">${row.Konto || ''}</td>
                        <td class="p-2">${row.Zahlungsmethode || ''}</td>
                        <td class="p-2">${row.Wiederkehrend || ''}</td>
                        <td class="p-2">${row['Sonstige Infos'] || ''}</td>
                        <td class="p-2 text-center flex justify-center items-center gap-2">
                           <button class="action-btn edit-btn" data-id="${row.id}" title="Transaktion bearbeiten">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                           </button>
                           <button class="action-btn delete-btn" data-id="${row.id}" title="Transaktion löschen">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                           </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            function createOrUpdateCharts(summary) {
                const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
                const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim() + '80';
                const chartColors = {
                    ausgaben: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#f43f5e'],
                    einnahmen: ['#22c55e', '#16a34a', '#15803d', '#10b285'],
                    konto: ['#3b82f6', '#8b5cf6', '#ec4899', '#6366f1']
                };
                const doughnutOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: textColor
                            }
                        }
                    }
                };
                const barOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            }
                        },
                        x: {
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            }
                        }
                    }
                };
                const createChart = (id, type, data, options, colors) => {
                    if (charts[id]) charts[id].destroy();
                    const canvas = document.getElementById(id + 'Chart');
                    if (!canvas) return;
                    charts[id] = new Chart(canvas.getContext('2d'), {
                        type,
                        data: {
                            labels: Object.keys(data),
                            datasets: [{
                                data: Object.values(data),
                                backgroundColor: colors,
                                borderWidth: 0
                            }]
                        },
                        options
                    });
                };
                createChart('ausgaben', 'doughnut', summary.ausgabenByCat, doughnutOptions, chartColors.ausgaben);
                createChart('einnahmen', 'doughnut', summary.einnahmenByCat, doughnutOptions, chartColors.einnahmen);
                createChart('konto', 'bar', summary.ausgabenByKonto, barOptions, chartColors.konto);
            }

            function renderPaginationControls(totalItems) {
                const paginationControls = document.getElementById('pagination-controls');
                paginationControls.innerHTML = '';
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                if (totalPages <= 1) return;
                const startItem = (currentPage - 1) * itemsPerPage + 1;
                const endItem = Math.min(currentPage * itemsPerPage, totalItems);
                paginationControls.innerHTML = `<span class="text-sm subtle-text">Zeige ${startItem}–${endItem} von ${totalItems}</span><div class="flex items-center gap-2"><button id="prev-page-btn" class="filter-btn px-3 py-1 rounded-md font-semibold transition text-sm">Zurück</button><span class="text-sm subtle-text font-semibold px-2">Seite ${currentPage} von ${totalPages}</span><button id="next-page-btn" class="filter-btn px-3 py-1 rounded-md font-semibold transition text-sm">Weiter</button></div>`;
                const prevBtn = document.getElementById('prev-page-btn');
                const nextBtn = document.getElementById('next-page-btn');
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;
                if (prevBtn.disabled) prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
                if (nextBtn.disabled) nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
                prevBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        updateDashboard();
                    }
                });
                nextBtn.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        updateDashboard();
                    }
                });
            }

            // --- KALENDER LOGIC ---
            const calendarGridDesktop = document.getElementById('calendar-grid-desktop');
            const calendarHeaderDesktop = document.getElementById('calendar-header-desktop');
            const calendarGridMobile = document.getElementById('calendar-grid-mobile');
            const calendarHeaderMobile = document.getElementById('calendar-header-mobile');

            function renderCalendar() {
                const targets = [{
                    grid: calendarGridDesktop,
                    header: calendarHeaderDesktop
                }, {
                    grid: calendarGridMobile,
                    header: calendarHeaderMobile
                }];
                const month = calendarDate.getMonth(),
                    year = calendarDate.getFullYear();
                const monthName = new Intl.DateTimeFormat('de-DE', {
                    month: 'long',
                    year: 'numeric'
                }).format(calendarDate);
                const todayStr = new Date().toISOString().slice(0, 10);

                targets.forEach(target => {
                    if (!target.grid || !target.header) return;

                    target.grid.innerHTML = '';
                    target.header.innerHTML = `
                        <button data-action="prev-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                        <h3 class="text-lg font-semibold text-center w-48">${monthName}</h3>
                        <button data-action="next-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                    `;

                    ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'].forEach(day => {
                        const el = document.createElement('div');
                        el.className = 'font-bold subtle-text text-sm h-9 flex items-center justify-center';
                        el.textContent = day;
                        target.grid.appendChild(el);
                    });

                    const firstDayOfMonth = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const startOffset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
                    for (let i = 0; i < startOffset; i++) {
                        target.grid.appendChild(document.createElement('div'));
                    }

                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayButton = document.createElement('button');
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        dayButton.dataset.date = dateStr;
                        dayButton.textContent = day;
                        dayButton.className = 'calendar-day text-sm';
                        if (transactionDates.has(dateStr)) dayButton.classList.add('has-transactions');
                        if (dateStr === todayStr) dayButton.classList.add('today');
                        if (dateStr === selectedDate) dayButton.classList.add('selected');
                        dayButton.addEventListener('click', handleDateClick);
                        target.grid.appendChild(dayButton);
                    }
                });

                document.querySelectorAll('[data-action="prev-month"]').forEach(btn => btn.addEventListener('click', () => {
                    calendarDate.setMonth(calendarDate.getMonth() - 1);
                    renderCalendar();
                }));
                document.querySelectorAll('[data-action="next-month"]').forEach(btn => btn.addEventListener('click', () => {
                    calendarDate.setMonth(calendarDate.getMonth() + 1);
                    renderCalendar();
                }));

                lucide.createIcons();
            }

            function handleDateClick(e) {
                const clickedDate = e.currentTarget.dataset.date;
                currentPage = 1;
                selectedDate = (selectedDate === clickedDate) ? null : clickedDate;

                const clearBtnDesktop = document.getElementById('clear-date-filter-btn-desktop');
                const clearBtnMobile = document.getElementById('clear-date-filter-btn-mobile');
                clearBtnDesktop.classList.toggle('hidden', !selectedDate);
                clearBtnMobile.classList.toggle('hidden', !selectedDate);

                renderCalendar();
                updateDashboard();
                closeCalendarSidebar();
            }

            // --- CSV IMPORT / EXPORT ---
            function exportToCSV() {
                const headers = ['Datum', 'Art', 'Betrag', 'Beschreibung', 'Kategorie', 'Konto', 'Zahlungsmethode', 'Wiederkehrend', 'Sonstige Infos'];
                const dataToExport = allTransactions.map(t => ({
                    Datum: t.Datum,
                    Art: t.Art,
                    Betrag: String(t.Betrag).replace('.', ','),
                    Beschreibung: t.Beschreibung,
                    Kategorie: t.Kategorie,
                    Konto: t.Konto,
                    Zahlungsmethode: t.Zahlungsmethode,
                    Wiederkehrend: t.Wiederkehrend,
                    'Sonstige Infos': t['Sonstige Infos']
                }));
                const csv = Papa.unparse({
                    fields: headers,
                    data: dataToExport
                });
                const blob = new Blob([csv], {
                    type: 'text/csv;charset=utf-8;'
                });
                const link = document.createElement("a");
                link.setAttribute("href", URL.createObjectURL(blob));
                link.setAttribute("download", "aurimea-transaktionen.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function importFromCSV(file) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        let importedCount = 0;
                        results.data.forEach(row => {
                            if (!row.Datum || !row.Betrag || !row.Art) {
                                console.warn("Skipping invalid row:", row);
                                return;
                            }
                            const dateParts = row.Datum.split('.');
                            const parsedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
                            const newTransaction = {
                                id: crypto.randomUUID(),
                                'Datum': row.Datum,
                                'Art': row.Art,
                                'Betrag': parseFloat(String(row.Betrag).replace(',', '.')),
                                'Beschreibung': row.Beschreibung || '',
                                'Kategorie': row.Kategorie || '',
                                'Konto': row.Konto || '',
                                'Zahlungsmethode': row.Zahlungsmethode || '',
                                'Wiederkehrend': row.Wiederkehrend === 'Ja' ? 'Ja' : 'Nein',
                                'parsedDate': parsedDate,
                                'Sonstige Infos': row['Sonstige Infos'] || ''
                            };
                            allTransactions.push(newTransaction);
                            transactionDates.add(newTransaction.parsedDate);
                            importedCount++;
                        });
                        if (importedCount > 0) {
                            saveTransactions();
                            updateDashboard();
                            renderCalendar();
                            showNotification(`${importedCount} Transaktionen erfolgreich importiert!`);
                        } else {
                            showNotification("Keine gültigen Transaktionen in der Datei gefunden.");
                        }
                    },
                    error: (err) => {
                        showNotification("Fehler beim Parsen der CSV-Datei.");
                        console.error("CSV Parse Error:", err);
                    }
                });
            }

            // --- CONFIRMATION MODAL & NOTIFICATION LOGIC ---
            function showNotification(message, duration = 3000) {
                notificationMessage.textContent = message;
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, duration);
            }

            function openConfirmModal(title, text, onConfirm) {
                confirmModalTitle.textContent = title;
                confirmModalText.textContent = text;
                confirmCallback = onConfirm;
                confirmModalOverlay.classList.remove('opacity-0', 'pointer-events-none');
                confirmModal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
            }

            function closeConfirmModal() {
                confirmModalOverlay.classList.add('opacity-0', 'pointer-events-none');
                confirmModal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                confirmCallback = null;
            }

            confirmCancelBtn.addEventListener('click', closeConfirmModal);
            confirmConfirmBtn.addEventListener('click', () => {
                if (typeof confirmCallback === 'function') {
                    confirmCallback();
                }
                closeConfirmModal();
            });
            confirmModalOverlay.addEventListener('click', closeConfirmModal);


            // --- EVENT LISTENERS ---
            document.getElementById('transaction-search-input').addEventListener('input', (e) => {
                currentPage = 1;
                searchTerm = e.target.value;
                document.getElementById('clear-search-btn').classList.toggle('hidden', !searchTerm);
                updateDashboard();
            });
            document.getElementById('clear-search-btn').addEventListener('click', () => {
                currentPage = 1;
                document.getElementById('transaction-search-input').value = '';
                searchTerm = '';
                document.getElementById('clear-search-btn').classList.add('hidden');
                updateDashboard();
            });
            document.getElementById('account-filter').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    currentPage = 1;
                    currentFilter = e.target.dataset.filter;
                    document.querySelectorAll('#account-filter button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    updateDashboard();
                }
            });
            document.querySelectorAll('.table-header-sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const key = header.dataset.sort;
                    currentPage = 1;
                    sortConfig.direction = (sortConfig.key === key && sortConfig.direction === 'asc') ? 'desc' : 'asc';
                    sortConfig.key = key;
                    updateDashboard();
                });
            });

            const clearFilterAction = () => {
                selectedDate = null;
                currentPage = 1;
                document.getElementById('clear-date-filter-btn-desktop').classList.add('hidden');
                document.getElementById('clear-date-filter-btn-mobile').classList.add('hidden');
                renderCalendar();
                updateDashboard();
            };
            document.getElementById('clear-date-filter-btn-desktop').addEventListener('click', clearFilterAction);
            document.getElementById('clear-date-filter-btn-mobile').addEventListener('click', clearFilterAction);

            document.getElementById('import-csv-btn').addEventListener('click', () => document.getElementById('csv-file-input').click());
            document.getElementById('csv-file-input').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importFromCSV(e.target.files[0]);
                }
            });
            document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);

            document.getElementById('delete-all-transactions-btn').addEventListener('click', () => {
                openConfirmModal(
                    'Alle Transaktionen löschen',
                    'Möchten Sie WIRKLICH ALLE Transaktionen unwiderruflich löschen? Diese Aktion kann nicht rückgängig gemacht werden!',
                    () => {
                        allTransactions = [];
                        transactionDates = new Set();
                        saveTransactions();
                        updateDashboard();
                        renderCalendar();
                        showNotification('Alle Transaktionen wurden erfolgreich gelöscht.');
                    }
                );
            });

            document.getElementById('transaction-table-body').addEventListener('click', (e) => {
                const editButton = e.target.closest('.edit-btn');
                const deleteButton = e.target.closest('.delete-btn');
                if (editButton) {
                    openModal(editButton.dataset.id);
                } else if (deleteButton) {
                    openConfirmModal(
                        'Transaktion löschen',
                        'Möchten Sie diese Transaktion wirklich löschen?',
                        () => {
                            const idToDelete = deleteButton.dataset.id;
                            allTransactions = allTransactions.filter(t => t.id !== idToDelete);
                            transactionDates = new Set(allTransactions.map(t => t.parsedDate));
                            saveTransactions();
                            updateDashboard();
                            renderCalendar();
                            showNotification('Transaktion gelöscht.');
                        }
                    );
                }
            });

            // --- TRANSACTION MODAL LOGIC (ADD/EDIT) ---
            const modal = document.getElementById('transaction-modal');
            const modalOverlay = document.getElementById('transaction-modal-overlay');
            const modalForm = document.getElementById('transaction-form');
            const modalTitle = document.getElementById('modal-title');
            const transArtSelect = document.getElementById('trans-art');
            const transKategorieSelect = document.getElementById('trans-kategorie');
            const transKontoSelect = document.getElementById('trans-konto');
            const paymentMethodRadios = document.querySelectorAll('input[name="trans-zahlungsmethode"]');


            function handlePaymentMethodChange() {
                const isCash = document.getElementById('trans-zahlungsmethode-bar').checked;
                transKontoSelect.disabled = isCash;
                if (isCash) {
                    transKontoSelect.value = ''; // Clear selection
                    transKontoSelect.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-100', 'dark:bg-gray-700/50');
                    transKontoSelect.required = false;
                } else {
                    transKontoSelect.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-100', 'dark:bg-gray-700/50');
                    transKontoSelect.required = true;
                    if (!transKontoSelect.value && transKontoSelect.options.length > 0) {
                        transKontoSelect.value = transKontoSelect.options[0].value;
                    }
                }
            }

            paymentMethodRadios.forEach(radio => radio.addEventListener('change', handlePaymentMethodChange));

            function updateCategoryOptions() {
                const selectedArt = transArtSelect.value;
                const categories = selectedArt === 'Ausgabe' ? expenseCategories : incomeCategories;
                transKategorieSelect.innerHTML = '';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    transKategorieSelect.appendChild(option);
                });
            }

            transArtSelect.addEventListener('change', updateCategoryOptions);

            function openModal(transactionId = null) {
                modalForm.reset();
                document.getElementById('trans-zahlungsmethode-karte').checked = true;

                if (transactionId) {
                    modalTitle.textContent = "Transaktion bearbeiten";
                    const transaction = allTransactions.find(t => t.id === transactionId);
                    if (transaction) {
                        modalForm.dataset.editingId = transactionId;
                        document.getElementById('trans-datum').value = transaction.parsedDate;
                        document.getElementById('trans-art').value = transaction.Art;
                        document.getElementById('trans-betrag').value = transaction.Betrag;
                        document.getElementById('trans-beschreibung').value = transaction.Beschreibung;
                        updateCategoryOptions();
                        document.getElementById('trans-kategorie').value = transaction.Kategorie;
                        document.getElementById('trans-konto').value = transaction.Konto;
                        if (transaction.Zahlungsmethode === 'Bar') {
                            document.getElementById('trans-zahlungsmethode-bar').checked = true;
                        } else {
                            document.getElementById('trans-zahlungsmethode-karte').checked = true;
                        }
                        document.getElementById('trans-wiederkehrend').checked = transaction.Wiederkehrend === 'Ja';
                        document.getElementById('trans-sonstige-infos').value = transaction['Sonstige Infos'] || '';
                    }
                } else {
                    modalTitle.textContent = "Neue Transaktion hinzufügen";
                    delete modalForm.dataset.editingId;
                    document.getElementById('trans-datum').value = new Date().toISOString().split('T')[0];
                    updateCategoryOptions();
                }

                handlePaymentMethodChange(); // Setzt den initialen Status des Kontofelds

                modalOverlay.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
            }

            function closeModal() {
                modalOverlay.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
            }

            document.getElementById('add-transaction-btn').addEventListener('click', () => openModal());
            document.getElementById('fab-add-transaction').addEventListener('click', () => openModal());
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', closeModal);

            modalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const editingId = modalForm.dataset.editingId;
                const parsedDate = document.getElementById('trans-datum').value;
                const dateParts = parsedDate.split('-');
                const displayDate = `${dateParts[2]}.${dateParts[1]}.${dateParts[0]}`;
                const transactionData = {
                    Datum: displayDate,
                    Art: document.getElementById('trans-art').value,
                    Betrag: parseFloat(document.getElementById('trans-betrag').value),
                    Beschreibung: document.getElementById('trans-beschreibung').value,
                    Kategorie: document.getElementById('trans-kategorie').value,
                    Konto: document.getElementById('trans-konto').value, // This will be '' if cash is selected
                    Zahlungsmethode: document.querySelector('input[name="trans-zahlungsmethode"]:checked').value,
                    Wiederkehrend: document.getElementById('trans-wiederkehrend').checked ? 'Ja' : 'Nein',
                    parsedDate: parsedDate,
                    ['Sonstige Infos']: document.getElementById('trans-sonstige-infos').value
                };

                if (editingId) {
                    const index = allTransactions.findIndex(t => t.id === editingId);
                    if (index !== -1) {
                        allTransactions[index] = {
                            ...allTransactions[index],
                            ...transactionData
                        };
                    }
                } else {
                    allTransactions.push({
                        ...transactionData,
                        id: crypto.randomUUID()
                    });
                }

                transactionDates = new Set(allTransactions.map(t => t.parsedDate));
                saveTransactions();
                currentPage = 1;
                updateDashboard();
                renderCalendar();
                closeModal();
            });

            // --- KALENDER SEITENLEISTE LOGIK (NEU) ---
            const calendarSidebar = document.getElementById('calendar-sidebar');
            const calendarSidebarOverlay = document.getElementById('calendar-sidebar-overlay');
            const openCalendarBtn = document.getElementById('fab-open-calendar');
            const closeCalendarBtn = document.getElementById('close-calendar-sidebar-btn');

            function openCalendarSidebar() {
                calendarSidebarOverlay.classList.remove('opacity-0', 'pointer-events-none');
                calendarSidebar.classList.remove('translate-x-full');
                lucide.createIcons();
            }

            function closeCalendarSidebar() {
                calendarSidebarOverlay.classList.add('opacity-0', 'pointer-events-none');
                calendarSidebar.classList.add('translate-x-full');
            }

            openCalendarBtn.addEventListener('click', openCalendarSidebar);
            closeCalendarBtn.addEventListener('click', closeCalendarSidebar);
            calendarSidebarOverlay.addEventListener('click', closeCalendarSidebar);


            // --- THEME SYNCHRONISATION ---
            const themeObserver = new MutationObserver((mutations) => {
                mutations.forEach(mutation => {
                    if (mutation.attributeName === 'data-theme') {
                        const accountFilteredData = (currentFilter === 'all') ? allTransactions : allTransactions.filter(row => row.Konto === currentFilter);
                        const financialSummary = processData(accountFilteredData);
                        createOrUpdateCharts(financialSummary);
                    }
                });
            });
            themeObserver.observe(document.documentElement, {
                attributes: true
            });

            window.addEventListener('message', (event) => {
                if (typeof event.data === 'string' && event.data.startsWith('set-theme-')) {
                    const theme = event.data.split('-')[2];
                    if (theme === 'light' || theme === 'dark') {
                        document.documentElement.dataset.theme = theme;
                    }
                }
            });

            // --- INITIALIZATION ---
            loadTransactions();
            updateDashboard();
            renderCalendar();
            lucide.createIcons(); // Initial call for any icons outside dynamic components
        });
    </script>
</body>

</html>
