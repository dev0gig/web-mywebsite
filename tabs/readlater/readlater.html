<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReadlateR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #171717;
            /* neutral-900 */
            color: #fafafa;
            /* neutral-50 */
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #171717;
        }

        ::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #525252;
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            padding: 0;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        .spinner {
            border: 2px solid #404040;
            border-top-color: #a3a3a3;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transition: bottom 0.5s ease-in-out;
            z-index: 70;
        }

        #toast.show {
            bottom: 20px;
        }

        #toast.success {
            background-color: #22c55e;
        }

        #toast.error {
            background-color: #ef4444;
        }

        #toast.loading {
            background-color: #525252;
        }

        .modal-hidden {
            opacity: 0;
            pointer-events: none;
        }

        #confirm-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 50;
            transition: opacity 0.3s;
        }

        #confirm-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 60;
            transition: opacity 0.3s;
        }
    </style>
</head>

<body class="antialiased">

    <div id="app" class="w-full mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 flex justify-between items-center">
            <div class="text-left">
                <h1 class="text-4xl font-bold text-white tracking-tight">ReadlateR</h1>
                <p class="text-neutral-400 mt-1">Dein persönliches Lesezeichen-Archiv.</p>
            </div>
            <div id="header-actions" class="flex gap-2 items-center">
                <button id="clear-archive-btn"
                    class="hidden text-sm bg-red-800 hover:bg-red-700 text-white font-medium rounded-md px-4 py-2 transition">Archiv
                    leeren</button>
                <label for="import-file"
                    class="cursor-pointer text-sm bg-blue-700 hover:bg-blue-600 text-white font-medium rounded-md px-4 py-2 transition flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-box-arrow-in-down" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M3.5 10a.5.5 0 0 1-.5-.5v-8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 0 0 1h2A1.5 1.5 0 0 0 14 9.5v-8A1.5 1.5 0 0 0 12.5 0h-9A1.5 1.5 0 0 0 2 1.5v8A1.5 1.5 0 0 0 3.5 11h2a.5.5 0 0 0 0-1z" />
                        <path fill-rule="evenodd"
                            d="M7.646 15.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 14.293V5.5a.5.5 0 0 0-1 0v8.793l-2.146-2.147a.5.5 0 0 0-.708.708z" />
                    </svg>
                    <span>Import</span>
                </label>
                <input type="file" id="import-file" class="visually-hidden" accept="application/json">
                <button id="export-btn"
                    class="text-sm bg-green-700 hover:bg-green-600 text-white font-medium rounded-md px-4 py-2 transition flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-box-arrow-up" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M3.5 15a.5.5 0 0 1-.5-.5v-8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 0 0 1h2A1.5 1.5 0 0 0 14 14.5v-8A1.5 1.5 0 0 0 12.5 5h-9A1.5 1.5 0 0 0 2 6.5v8A1.5 1.5 0 0 0 3.5 16h2a.5.5 0 0 0 0-1z" />
                        <path fill-rule="evenodd"
                            d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708-.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708z" />
                    </svg>
                    <span>Export</span>
                </button>
            </div>
        </header>

        <!-- Add new link form with Live Preview -->
        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-neutral-800 p-4 sm:p-6 rounded-lg border border-neutral-700">
                <h2 class="text-xl font-bold mb-4">Neuen Link hinzufügen</h2>
                <form id="add-link-form" class="space-y-4">
                    <div>
                        <label for="link-url" class="block text-sm font-medium text-neutral-300 mb-1">URL</label>
                        <input type="url" id="link-url" placeholder="https://..." required
                            class="w-full bg-neutral-900 border border-neutral-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-neutral-500 transition">
                    </div>
                    <div>
                        <label for="link-tags" class="block text-sm font-medium text-neutral-300 mb-1">Tags
                            (kommagetrennt)</label>
                        <input type="text" id="link-tags" placeholder="z.B. design, inspiration, ..."
                            class="w-full bg-neutral-900 border border-neutral-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-neutral-500 transition">
                    </div>
                    <button type="submit" id="submit-btn"
                        class="w-full sm:w-auto bg-neutral-700 hover:bg-neutral-600 text-white font-semibold rounded-md px-6 py-2.5 transition duration-200 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            viewBox="0 0 16 16">
                            <path
                                d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                        </svg>
                        <span>Link speichern</span>
                    </button>
                </form>
            </div>
            <div class="hidden lg:block bg-neutral-800 p-4 sm:p-6 rounded-lg border border-neutral-700">
                <h2 class="text-xl font-bold mb-4">Live-Vorschau</h2>
                <div id="live-preview-container" class="h-full">
                    <!-- Preview will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="mb-8 space-y-4">
            <div class="flex justify-between items-center">
                <div class="relative w-full">
                    <input type="search" id="search-input" placeholder="Suche in Titeln und URLs..."
                        class="w-full bg-neutral-800 border border-neutral-700 rounded-md pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-neutral-500">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-neutral-400"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <button id="toggle-archive-btn"
                    class="ml-4 flex-shrink-0 text-sm bg-neutral-700 hover:bg-neutral-600 text-neutral-200 font-medium rounded-md px-4 py-2 transition">Archiv</button>
            </div>
            <div id="domain-filters-container" class="flex flex-wrap gap-2 items-center"></div>
            <div id="tag-filters-container" class="flex flex-wrap gap-2 items-center mt-2"></div>
        </div>

        <!-- Links Container -->
        <main id="links-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></main>
        <div id="empty-state"
            class="hidden text-center py-16 px-6 bg-neutral-800/50 rounded-lg border border-dashed border-neutral-700">
            <h3 id="empty-state-title" class="text-lg font-semibold text-white"></h3>
            <p id="empty-state-text" class="mt-1 text-sm text-neutral-400"></p>
        </div>
    </div>

    <!-- Toast & Modals -->
    <div id="toast"></div>
    <div id="confirm-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 modal-hidden"></div>
    <div id="confirm-modal" class="w-11/12 max-w-md bg-neutral-800 rounded-lg shadow-lg p-6 modal-hidden">
        <h3 id="confirm-modal-title" class="text-xl font-bold mb-4">Aktion bestätigen</h3>
        <p id="confirm-modal-text" class="mb-6 text-neutral-300">Möchten Sie diese Aktion wirklich ausführen?</p>
        <div class="flex justify-end gap-4">
            <button id="confirm-modal-cancel-btn"
                class="bg-neutral-600 hover:bg-neutral-500 text-white font-bold py-2 px-4 rounded-lg transition">Abbrechen</button>
            <button id="confirm-modal-confirm-btn"
                class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">Bestätigen</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const form = document.getElementById('add-link-form');
            const linkUrlInput = document.getElementById('link-url');
            const linkTagsInput = document.getElementById('link-tags');
            const linksContainer = document.getElementById('links-container');
            const searchInput = document.getElementById('search-input');
            const domainFiltersContainer = document.getElementById('domain-filters-container');
            const tagFiltersContainer = document.getElementById('tag-filters-container');
            const toggleArchiveBtn = document.getElementById('toggle-archive-btn');
            const clearArchiveBtn = document.getElementById('clear-archive-btn');
            const emptyState = document.getElementById('empty-state');
            const emptyStateTitle = document.getElementById('empty-state-title');
            const emptyStateText = document.getElementById('empty-state-text');
            const toast = document.getElementById('toast');
            const exportBtn = document.getElementById('export-btn');
            const importFileInput = document.getElementById('import-file');
            const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmModalTitle = document.getElementById('confirm-modal-title');
            const confirmModalText = document.getElementById('confirm-modal-text');
            const confirmCancelBtn = document.getElementById('confirm-modal-cancel-btn');
            const confirmConfirmBtn = document.getElementById('confirm-modal-confirm-btn');
            const livePreviewContainer = document.getElementById('live-preview-container');

            // --- State ---
            let links = [];
            let viewState = { showArchived: false, searchTerm: '', filterTag: null, filterDomain: null };
            let isFetchingMetadata = false;
            let confirmCallback = null;
            let previewData = null; // To hold fetched preview data

            // --- Utils ---
            const showToast = (message, type = 'success', duration = 3000) => {
                toast.textContent = message;
                toast.className = `show ${type}`;
                if (duration > 0) {
                    setTimeout(() => { toast.className = ''; }, duration);
                }
            };
            const getStoredLinks = () => {
                const linksJSON = localStorage.getItem('readLaterLinks');
                let storedLinks = linksJSON ? JSON.parse(linksJSON) : [];
                return storedLinks.map(link => {
                    const defaults = { title: link.url || '', description: '', image: '', tags: [], status: 'active', metadataStatus: 'pending', hostname: '' };
                    let finalLink = { ...defaults, ...link };
                    if (finalLink.metadataStatus === 'failed') {
                        finalLink.metadataStatus = 'pending';
                        finalLink.description = 'Lade Metadaten erneut...';
                    }
                    return finalLink;
                });
            };
            const saveLinks = () => localStorage.setItem('readLaterLinks', JSON.stringify(links));

            const openConfirmModal = (title, text, onConfirm) => {
                confirmModalTitle.textContent = title;
                confirmModalText.textContent = text;
                confirmCallback = onConfirm;
                confirmModalOverlay.classList.remove('modal-hidden');
                confirmModal.classList.remove('modal-hidden');
            };

            const closeConfirmModal = () => {
                confirmModalOverlay.classList.add('modal-hidden');
                confirmModal.classList.add('modal-hidden');
                confirmCallback = null;
            };

            const getHostname = (url) => {
                try {
                    return new URL(url).hostname.replace(/^www\./, '');
                } catch (e) {
                    return null;
                }
            };

            // --- Metadata Logic ---
            const fetchMetadataAPI = async (url) => {
                try {
                    const response = await fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}`);
                    if (response.ok) {
                        const { data } = await response.json();
                        return { title: data.title || url, description: data.description || '', image: data.image?.url || '' };
                    }
                } catch (e) { console.error("Microlink fetch failed:", e); }
                try {
                    const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
                    if (response.ok) {
                        const html = await response.text();
                        const match = html.match(/<title>(.*?)<\/title>/i);
                        return { title: match ? match[1] : url, description: 'Keine Beschreibung gefunden (Fallback).', image: '' };
                    }
                } catch (e) { console.error("Proxy fetch failed:", e); }
                return null;
            };

            const processMetadataQueue = async () => {
                if (isFetchingMetadata) return;
                isFetchingMetadata = true;

                const pendingLinks = links.filter(link => link.metadataStatus === 'pending');
                if (pendingLinks.length === 0) {
                    isFetchingMetadata = false;
                    return;
                }

                console.log(`Processing metadata for ${pendingLinks.length} link(s)...`);
                let updated = false;
                for (const link of pendingLinks) {
                    link.hostname = getHostname(link.url);
                    const metadata = await fetchMetadataAPI(link.url);
                    if (metadata) {
                        link.title = metadata.title;
                        link.description = metadata.description;
                        link.image = metadata.image;
                        link.metadataStatus = 'completed';
                        updated = true;
                    } else {
                        link.metadataStatus = 'failed';
                        link.description = 'Metadaten konnten nicht geladen werden.';
                        updated = true;
                    }
                }

                if (updated) {
                    saveLinks();
                    render();
                }
                isFetchingMetadata = false;
            };

            const renderLinkCard = (link, isPreview = false) => {
                const tagsHTML = (link.tags || []).map(tag => `<span class="bg-neutral-700 text-xs font-medium px-2 py-1 rounded-full">${tag}</span>`).join(' ');
                const faviconUrl = `https://t1.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=${link.url}&size=16`;
                const placeholderImg = `https://placehold.co/600x400/262626/525252?text=${link.hostname || ''}`;

                let statusActions = '';
                if (!isPreview) {
                    if (link.status === 'active') {
                        statusActions = `<button data-id="${link.id}" class="archive-btn text-sm font-medium text-neutral-300 hover:text-white transition">Archivieren</button>`;
                    } else {
                        statusActions = `<button data-id="${link.id}" class="restore-btn text-sm font-medium text-neutral-300 hover:text-white transition">Wiederherstellen</button>
                                   <button data-id="${link.id}" class="delete-btn text-sm font-medium text-red-400 hover:text-red-300 transition">Endgültig Löschen</button>`;
                    }
                    if (link.metadataStatus === 'failed') {
                        statusActions += `<button data-id="${link.id}" class="retry-meta-btn text-sm font-medium text-neutral-400 hover:text-neutral-300 transition ml-auto">Erneut versuchen</button>`;
                    }
                }

                return `
                <div class="md:w-64 lg:w-80 flex-shrink-0 h-48 md:h-full">
                   <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="h-full block">
                        <img src="${link.image}" onerror="this.onerror=null;this.src='${placeholderImg}';" alt="Vorschaubild für ${link.title}" class="object-cover w-full h-full">
                    </a>
                </div>
                <div class="p-4 flex flex-col flex-grow overflow-hidden">
                    <h2 class="text-lg font-bold text-white mb-2"><a href="${link.url}" target="_blank" rel="noopener noreferrer" class="hover:text-neutral-300">${link.title}</a></h2>
                    <p class="text-sm text-neutral-400 mb-3 flex-grow overflow-hidden">${link.description}</p>
                    <div class="flex items-center text-xs text-neutral-500 truncate mb-4">
                        <img src="${faviconUrl}" class="w-4 h-4 mr-2" alt="Favicon" />
                        <a href="${link.url}" target="_blank" rel="noopener noreferrer">${link.hostname || link.url}</a>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-4">${tagsHTML}</div>
                    <div class="mt-auto flex gap-2 pt-4 border-t border-neutral-700/50">${statusActions}</div>
                </div>
            `;
            }

            const render = () => {
                const filteredLinks = links.filter(link => {
                    const matchesArchive = viewState.showArchived ? link.status === 'archived' : link.status === 'active';
                    const matchesSearch = !viewState.searchTerm || link.title.toLowerCase().includes(viewState.searchTerm) || link.url.toLowerCase().includes(viewState.searchTerm);
                    const matchesTag = !viewState.filterTag || link.tags.includes(viewState.filterTag);
                    const matchesDomain = !viewState.filterDomain || link.hostname === viewState.filterDomain;
                    return matchesArchive && matchesSearch && matchesTag && matchesDomain;
                });

                toggleArchiveBtn.classList.toggle('bg-violet-600', viewState.showArchived);
                toggleArchiveBtn.classList.toggle('hover:bg-violet-500', viewState.showArchived);
                toggleArchiveBtn.classList.toggle('bg-neutral-700', !viewState.showArchived);
                toggleArchiveBtn.classList.toggle('hover:bg-neutral-600', !viewState.showArchived);
                clearArchiveBtn.classList.toggle('hidden', !viewState.showArchived);

                emptyState.classList.toggle('hidden', filteredLinks.length > 0);
                linksContainer.classList.toggle('hidden', filteredLinks.length === 0);

                if (filteredLinks.length > 0) {
                    linksContainer.innerHTML = '';
                    filteredLinks.forEach(link => {
                        const linkElement = document.createElement('div');
                        linkElement.className = 'bg-neutral-800 rounded-lg border border-neutral-700 overflow-hidden flex flex-col md:flex-row md:h-56 transition hover:border-neutral-600';
                        linkElement.innerHTML = renderLinkCard(link);
                        linksContainer.appendChild(linkElement);
                    });
                } else {
                    emptyStateTitle.textContent = viewState.showArchived ? "Das Archiv ist leer" : "Noch keine Links gespeichert";
                    emptyStateText.textContent = viewState.showArchived ? "Archivierte Links erscheinen hier." : "Füge deinen ersten Link hinzu, um ihn später zu lesen.";
                }

                const createFilterButton = (container, label, filterType, filterValue) => {
                    const isActive = viewState[filterType] === filterValue;
                    const button = document.createElement('button');
                    button.textContent = label;
                    button.className = `px-3 py-1 rounded-full text-sm ${isActive ? 'bg-violet-600 text-white' : 'bg-neutral-700 hover:bg-neutral-600'}`;
                    button.onclick = () => {
                        viewState[filterType] = viewState[filterType] === filterValue ? null : filterValue;
                        render();
                    };
                    container.appendChild(button);
                };

                const sourceLinks = viewState.showArchived ? links.filter(l => l.status === 'archived') : links.filter(l => l.status === 'active');

                const domainsSource = sourceLinks;
                const allDomains = [...new Set(domainsSource.map(l => l.hostname).filter(Boolean))];
                domainFiltersContainer.innerHTML = '<span class="text-sm font-medium text-neutral-400">Websites:</span>';
                if (allDomains.length > 0) {
                    createFilterButton(domainFiltersContainer, 'Alle', 'filterDomain', null);
                    allDomains.forEach(domain => createFilterButton(domainFiltersContainer, domain, 'filterDomain', domain));
                }

                const tagsSource = sourceLinks;
                const allTags = [...new Set(tagsSource.flatMap(l => l.tags))];
                tagFiltersContainer.innerHTML = '<span class="text-sm font-medium text-neutral-400">Tags:</span>';
                if (allTags.length > 0) {
                    createFilterButton(tagFiltersContainer, 'Alle', 'filterTag', null);
                    allTags.forEach(tag => createFilterButton(tagFiltersContainer, tag, 'filterTag', tag));
                }
            };

            const renderPreview = (data) => {
                if (!data) {
                    livePreviewContainer.innerHTML = `<div class="flex items-center justify-center h-full text-neutral-500">Vorschau wird hier angezeigt...</div>`;
                    return;
                }
                const previewElement = document.createElement('div');
                previewElement.className = 'bg-neutral-800 rounded-lg border border-neutral-700 overflow-hidden flex flex-col md:flex-row md:h-56 h-full';
                previewElement.innerHTML = renderLinkCard(data, true);
                livePreviewContainer.innerHTML = '';
                livePreviewContainer.appendChild(previewElement);
            };

            let previewTimeout;
            const handleUrlInput = () => {
                clearTimeout(previewTimeout);
                const url = linkUrlInput.value.trim();
                if (!url) {
                    renderPreview(null);
                    return;
                }
                livePreviewContainer.innerHTML = `<div class="flex items-center justify-center h-full"><div class="spinner"></div></div>`;
                previewTimeout = setTimeout(async () => {
                    const metadata = await fetchMetadataAPI(url);
                    previewData = {
                        url,
                        tags: linkTagsInput.value.split(',').map(t => t.trim()).filter(Boolean),
                        hostname: getHostname(url),
                        ...(metadata || { title: url, description: 'Laden fehlgeschlagen.', image: '' })
                    };
                    renderPreview(previewData);
                }, 500);
            };

            // --- Event Listeners ---
            linkUrlInput.addEventListener('keyup', handleUrlInput);
            linkUrlInput.addEventListener('blur', handleUrlInput);
            linkTagsInput.addEventListener('keyup', () => {
                if (previewData) {
                    previewData.tags = linkTagsInput.value.split(',').map(t => t.trim()).filter(Boolean);
                    renderPreview(previewData);
                }
            });

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const url = linkUrlInput.value.trim();
                if (!url) return;

                let linkToAdd;
                if (previewData && previewData.url === url) {
                    linkToAdd = {
                        ...previewData,
                        id: Date.now(),
                        status: 'active',
                        metadataStatus: 'completed'
                    };
                } else {
                    linkToAdd = { id: Date.now(), url, tags: linkTagsInput.value.split(',').map(t => t.trim()).filter(Boolean), status: 'active', title: url, description: 'Lade Details...', image: '', metadataStatus: 'pending' };
                }

                links.unshift(linkToAdd);
                saveLinks();
                render();
                form.reset();
                renderPreview(null);
                previewData = null;
                showToast('Link hinzugefügt.', 'success');
                if (linkToAdd.metadataStatus === 'pending') {
                    processMetadataQueue();
                }
            });

            linksContainer.addEventListener('click', (e) => {
                const id = Number(e.target.dataset.id);
                if (!id) return;
                const linkIndex = links.findIndex(l => l.id === id);
                if (linkIndex === -1) return;

                if (e.target.matches('.archive-btn')) {
                    links[linkIndex].status = 'archived';
                } else if (e.target.matches('.restore-btn')) {
                    links[linkIndex].status = 'active';
                } else if (e.target.matches('.delete-btn')) {
                    links.splice(linkIndex, 1);
                } else if (e.target.matches('.retry-meta-btn')) {
                    links[linkIndex].metadataStatus = 'pending';
                    links[linkIndex].description = 'Lade Metadaten erneut...';
                    processMetadataQueue();
                }
                saveLinks();
                render();
            });

            toggleArchiveBtn.addEventListener('click', () => {
                viewState.showArchived = !viewState.showArchived;
                viewState.filterTag = null;
                viewState.filterDomain = null;
                render();
            });

            clearArchiveBtn.addEventListener('click', () => {
                openConfirmModal(
                    'Archiv leeren',
                    'Möchten Sie wirklich alle archivierten Einträge endgültig löschen? Diese Aktion kann nicht rückgängig gemacht werden.',
                    () => {
                        links = links.filter(link => link.status !== 'archived');
                        saveLinks();
                        render();
                        showToast('Archiv wurde geleert.', 'success');
                    }
                );
            });

            confirmCancelBtn.addEventListener('click', closeConfirmModal);
            confirmConfirmBtn.addEventListener('click', () => {
                if (typeof confirmCallback === 'function') {
                    confirmCallback();
                }
                closeConfirmModal();
            });
            confirmModalOverlay.addEventListener('click', closeConfirmModal);


            searchInput.addEventListener('input', (e) => { viewState.searchTerm = e.target.value.toLowerCase(); render(); });
            exportBtn.addEventListener('click', () => {
                if (links.length === 0) return showToast('Keine Links zum Exportieren vorhanden.', 'error');
                const dataStr = JSON.stringify(links, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `readlater_backup_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            });

            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (!Array.isArray(imported)) throw new Error('Invalid format');
                        const currentUrls = new Set(links.map(l => l.url));
                        const newLinksRaw = imported.filter(link => link.url && !currentUrls.has(link.url));

                        const newAndExistingLinks = [
                            ...links,
                            ...newLinksRaw.map(link => ({ ...link, id: link.id || Date.now() + Math.random(), title: link.url, description: 'Warte auf Metadaten...', image: '', metadataStatus: 'pending' }))
                        ];

                        const uniqueLinks = Array.from(new Map(newAndExistingLinks.map(link => [link.url, link])).values());

                        links = uniqueLinks;

                        saveLinks();
                        render();
                        showToast(`${newLinksRaw.length} Links importiert/aktualisiert. Lade Details...`);
                        processMetadataQueue();
                    } catch (error) {
                        showToast('Import fehlgeschlagen. Ungültige Datei.', 'error');
                    } finally {
                        importFileInput.value = '';
                    }
                };
                reader.readAsText(file);
            });

            // --- Initial Load ---
            links = getStoredLinks();
            render();
            renderPreview(null);
            processMetadataQueue(); // Check for pending links on load
        });
    </script>
</body>

</html>