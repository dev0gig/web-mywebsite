<!DOCTYPE html>
<html lang="de" class="h-full" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuriMea - Interaktives Finanz-Dashboard</title>
    <!-- Einbindung von Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Einbindung von Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Einbindung von Lucide Icons für den Kalender und andere Symbole -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Farben-Schema für Konsistenz */
        :root {
            --bg-color: #f9fafb;
            --text-color: #111827;
            --text-color-light: #6b7280;
            --header-color: #111827;
            --card-bg: #ffffff;
            --card-text: #111827;
            --subtle-text: #6b7280;
            --border-color: #e5e7eb;
            --edit-btn-hover-bg: #3b82f6;
            /* blue-600 */
        }

        html[data-theme='dark'] {
            --bg-color: #171717;
            --text-color: #fafafa;
            --text-color-light: #a3a3a3;
            --header-color: #fafafa;
            --card-bg: #262626;
            --card-text: #fafafa;
            --subtle-text: #a3a3a3;
            --border-color: #404040;
            --edit-btn-hover-bg: #2563eb;
            /* blue-700 */
        }

        html {
            /* Verhindert das "Springen" der Seite, wenn der Scrollbalken erscheint/verschwindet */
            scrollbar-gutter: stable;
        }

        body {
            font-family: 'Ubuntu', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            /* Fügt unten Platz hinzu, um zu verhindern, dass die schwebenden Buttons Inhalte überdecken,
               insbesondere auf Mobilgeräten. env(safe-area-inset-bottom) berücksichtigt die Home-Leiste auf iOS. */
            padding-bottom: 8rem;
        }

        @media (min-width: 1024px) {
            body {
                /* Setzt Padding für Desktop zurück, da die Buttons hier nicht schweben */
                padding-bottom: 1.5rem;
                /* Entspricht p-6 von Tailwind */
            }
        }

        /* --- Benutzerdefinierte Scrollbar-Stile --- */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 10px;
            border: 3px solid var(--bg-color);
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--subtle-text);
        }

        .main-title {
            color: var(--header-color);
        }

        .card {
            background-color: var(--card-bg);
            color: var(--card-text);
            border: 1px solid var(--border-color);
        }

        .subtle-text {
            color: var(--subtle-text);
        }

        .filter-btn {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--subtle-text);
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            /* Übergänge für Farben und Rahmen */
        }

        .filter-btn:hover {
            background-color: var(--border-color);
        }

        /* --- STILE FÜR AKTUELLE FILTER-BUTTONS (AKTIV-ZUSTAND) --- */
        .filter-btn.active {
            color: white;
            /* Textfarbe auf Weiß für alle aktiven Buttons */
            border-color: transparent;
            /* Setze Standard-Rahmen auf transparent, Farben werden spezifisch gesetzt */
        }

        .filter-btn.active[data-filter="all"] {
            background-color: #9333ea;
            /* Tailwind violet-600 */
            border-color: #9333ea;
        }

        .filter-btn.active[data-filter="all"]:hover {
            background-color: #7c2d12;
            /* Dunklerer Violett-Ton für Hover */
            border-color: #7c2d12;
        }

        .filter-btn.active[data-filter="Erste Bank"] {
            background-color: #2563eb;
            /* Tailwind blue-600 */
            border-color: #2563eb;
        }

        .filter-btn.active[data-filter="Erste Bank"]:hover {
            background-color: #1d4ed8;
            /* Dunklerer Blau-Ton für Hover */
            border-color: #1d4ed8;
        }

        .filter-btn.active[data-filter="N26"] {
            background-color: #14b8a6;
            /* Tailwind teal-500 (Türkis) */
            border-color: #14b8a6;
        }

        .filter-btn.active[data-filter="N26"]:hover {
            background-color: #0d9488;
            /* Dunklerer Türkis-Ton für Hover */
            border-color: #0d9488;
        }

        .filter-btn.active[data-filter="Revolut"] {
            background-color: #9ca3af;
            /* Tailwind gray-400 (Silber) */
            border-color: #9ca3af;
        }

        .filter-btn.active[data-filter="Revolut"]:hover {
            background-color: #6b7280;
            /* Dunklerer Grau-Ton für Hover */
            border-color: #6b7280;
        }

        /* --- ENDE STILE FÜR AKTUELLE FILTER-BUTTONS --- */


        .table-header-sortable:hover {
            background-color: var(--border-color);
            cursor: pointer;
        }

        #transaction-table-body tr:nth-child(even) {
            background-color: rgba(128, 128, 128, 0.05);
        }

        #transaction-table-body tr:hover {
            background-color: rgba(128, 128, 128, 0.1);
        }

        /* --- NEUE KALENDER-STILE (adaptiert von MemoMea) --- */
        .calendar-day {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            margin: auto;
            position: relative;
            border: none;
            background-color: transparent;
        }

        .calendar-day:hover {
            background-color: var(--border-color);
        }

        .calendar-day.has-transactions::after {
            content: '';
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background-color: #4f46e5;
            /* Indigo */
        }

        html[data-theme='dark'] .calendar-day.has-transactions::after {
            background-color: #818cf8;
            /* Indigo-400 */
        }

        .calendar-day.today {
            background-color: #dbeafe;
            /* blue-100 */
            color: #1e40af;
            /* blue-800 */
            font-weight: 700;
        }

        html[data-theme='dark'] .calendar-day.today {
            background-color: #1e3a8a;
            /* blue-900 */
            color: #eff6ff;
            /* blue-50 */
        }

        .calendar-day.selected {
            background-color: #4f46e5;
            color: white;
            font-weight: 700;
            box-shadow: none;
        }

        .calendar-day.selected:hover {
            background-color: #4338ca;
        }

        .calendar-day.selected.has-transactions::after {
            background-color: white;
        }

        /* --- ENDE NEUE KALENDER-STILE --- */

        /* Stile für Aktions-Buttons */
        .action-btn {
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            color: var(--subtle-text);
            transition: background-color 0.2s, color 0.2s;
        }

        .delete-btn:hover {
            background-color: #ef4444;
            color: white;
        }

        .edit-btn:hover {
            background-color: var(--edit-btn-hover-bg);
            color: white;
        }

        /* Stile für Benachrichtigungen */
        #notification {
            transition: opacity 0.3s, transform 0.3s;
        }

        #notification.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* Positionierung der schwebenden Aktionsbuttons unter Berücksichtigung der Safe Area */
        #fab-open-calendar {
            bottom: calc(6rem + env(safe-area-inset-bottom));
        }

        #fab-add-transaction {
            bottom: calc(1.5rem + env(safe-area-inset-bottom));
        }

        /* Standard-Desktop-Positionierung für das Transaktionsmodal */
        #transaction-modal {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            /* Standard-Breite, 11/12 von Tailwind ist 91.66% */
            max-width: 32rem;
            /* max-w-lg von Tailwind ist 32rem */
        }

        /* Maximale Höhe für den Inhalt des Transaktionsmodals auf Desktop */
        #transaction-modal .card {
            max-height: 90vh;
            /* Begrenze die Höhe auf 90% der Viewport-Höhe auf Desktop */
        }

        @media (max-width: 767px) {

            /* Für Mobilgeräte (bis md breakpoint) */
            #transaction-modal {
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                transform: none;
                /* Deaktiviere die Zentrier-Transformation */
                max-width: none;
                /* Entferne maximale Breite */
                border-radius: 0;
                /* Entferne abgerundete Ecken */
            }

            #transaction-modal .card {
                height: 100%;
                /* Sorge dafür, dass der Inhalt die volle Höhe einnimmt */
                max-height: 100%;
                /* Stelle sicher, dass es die volle Höhe einnimmt */
                border-radius: 0;
                /* Entferne abgerundete Ecken für den Inhalt */
                padding-bottom: env(safe-area-inset-bottom);
                /* Berücksichtige die Safe Area unten */
            }
        }

        /* Styles für das Kalendersymbol im Datumsfeld */
        .calendar-icon {
            color: var(--subtle-text);
            /* Standardfarbe für Light Mode */
        }

        html[data-theme='dark'] .calendar-icon {
            color: #fafafa;
            /* Weiß für Dark Mode */
        }

        /* --- RESPONSIVE TABELLEN-STILE --- */
        @media (max-width: 767px) {

            /* Verstecke den Tabellenkopf auf kleinen Bildschirmen */
            .responsive-table thead {
                display: none;
            }

            /* Jede Zeile wird zu einer Karte */
            .responsive-table tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid var(--border-color);
                border-radius: 0.75rem;
                /* rounded-xl */
                padding: 1rem;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            }

            /* Zellen werden untereinander dargestellt */
            .responsive-table td {
                display: block;
                text-align: right;
                padding: 0.5rem 0;
                border-bottom: 1px solid var(--border-color);
            }

            .responsive-table td:last-child {
                border-bottom: none;
            }

            /* Fügt das Label vor dem Zelleninhalt ein */
            .responsive-table td::before {
                content: attr(data-label);
                float: left;
                font-weight: 600;
                /* font-semibold */
                color: var(--text-color);
                margin-right: 1rem;
            }

            /* Leere Zellen nicht anzeigen */
            .responsive-table td:empty {
                display: none;
            }

            /* Spezifische Anpassungen für die Aktions-Buttons */
            .responsive-table td[data-label="Aktionen"] {
                padding-top: 1rem;
            }
        }

        /* --- Dashboard Modal für Mobile --- */
        @media (max-width: 1023px) {
            #dashboard-content-wrapper {
                display: none; /* Standardmäßig aus dem Layout entfernen */
            }

            #dashboard-content-wrapper.is-open {
                display: flex; /* Wenn offen, als Flex-Container anzeigen */
                position: fixed;
                inset: 0;
                background-color: var(--bg-color);
                z-index: 45;
                overflow-y: auto;
                padding: 1rem;
                padding-bottom: calc(1.5rem + env(safe-area-inset-bottom));
            }
        }
        /* --- ENDE Dashboard Modal --- */

        /* --- NEUE MODAL-STILE --- */
        .type-selector-btn {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--subtle-text);
            transition: all 0.2s ease-in-out;
            flex: 1;
        }

        .type-selector-btn.active {
            color: white;
        }

        .type-selector-btn[data-type="Ausgabe"].active {
            background-color: #ef4444;
            /* red-500 */
            border-color: #dc2626;
            /* red-600 */
        }

        .type-selector-btn[data-type="Einnahme"].active {
            background-color: #22c55e;
            /* green-500 */
            border-color: #16a34a;
            /* green-600 */
        }

        .type-selector-btn[data-type="Überweisung"].active {
            background-color: #3b82f6;
            /* blue-500 */
            border-color: #2563eb;
            /* blue-600 */
        }

        .form-input,
        .form-select {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #4f46e5;
            /* indigo-600 */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
        }

        .payment-method-radio-group label {
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .payment-method-radio-group input:checked+label {
            background-color: #dbeafe;
            /* blue-100 */
            border-color: #3b82f6;
            /* blue-500 */
            color: #1e40af;
            /* blue-800 */
            font-weight: 600;
        }

        html[data-theme='dark'] .payment-method-radio-group input:checked+label {
            background-color: #1e3a8a;
            /* blue-900 */
            border-color: #60a5fa;
            /* blue-400 */
            color: #eff6ff;
            /* blue-50 */
        }

        .template-btn {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            transition: all 0.2s;
            position: relative;
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: left;
            cursor: pointer;
            width: 100%;
        }

        .template-btn:hover {
            border-color: #4f46e5;
            /* indigo-600 */
            background-color: rgba(79, 70, 229, 0.05);
        }

        html[data-theme='dark'] .template-btn:hover {
            background-color: rgba(99, 102, 241, 0.1);
            /* indigo-400 with alpha */
        }

        .template-btn .delete-template {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: transparent;
            color: var(--subtle-text);
            border-radius: 9999px;
            padding: 2px;
            opacity: 0;
            transition: opacity 0.2s, color 0.2s, background-color 0.2s;
        }

        .template-btn:hover .delete-template {
            opacity: 1;
        }

        .delete-template:hover {
            background-color: #ef4444;
            /* red-500 */
            color: white;
        }
    </style>
    <style>
        details>summary {
            list-style: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        details>summary .icon {
            transition: transform 0.2s;
        }

        details[open]>summary .icon {
            transform: rotate(90deg);
        }
    </style>
</head>

<body class="p-4 md:p-6">
    <h1 class="text-3xl md:text-4xl font-bold main-title mb-6 text-center">AuriMea</h1>

    <!-- HAUPTINHALTSBEREICH -->
    <div class="w-full mx-auto flex flex-col lg:grid lg:grid-cols-5 lg:gap-6 px-4 md:px-6">

        <!-- Rechte Spalte (wird auf Mobile zuerst/oben angezeigt) -->
        <div id="dashboard-content-wrapper" class="lg:col-span-2 lg:order-2 flex flex-col gap-6">
            <!-- Close button for mobile modal view -->
            <div class="lg:hidden flex justify-between items-center mb-4 w-full flex-shrink-0">
                <h3 class="text-xl font-bold">Dashboard</h3>
                <button id="close-dashboard-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Block 1: Kennzahlen -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                <!-- Einnahmen -->
                <div class="card p-4 rounded-xl shadow-md text-center flex flex-col justify-center">
                    <h2 class="text-lg font-semibold subtle-text">Einnahmen</h2>
                    <p id="total-einnahmen" class="text-2xl font-bold text-green-500">0,00 €</p>
                </div>
                <!-- Ausgaben -->
                <div class="card p-4 rounded-xl shadow-md text-center flex flex-col justify-center">
                    <h2 class="text-lg font-semibold subtle-text">Ausgaben</h2>
                    <p id="total-ausgaben" class="text-2xl font-bold text-red-500">0,00 €</p>
                </div>
                <!-- Bilanz -->
                <div class="card p-4 rounded-xl shadow-md text-center flex flex-col justify-center">
                    <h2 class="text-lg font-semibold subtle-text">Bilanz</h2>
                    <p id="bilanz" class="text-2xl font-bold">0,00 €</p>
                </div>
            </div>

            <!-- Block 2: Konten-Filter -->
            <div class="card p-4 rounded-xl shadow-md">
                <h2 class="text-lg font-semibold subtle-text mb-3 text-center">Konten</h2>
                <div id="account-filter" class="grid grid-cols-2 gap-2">
                    <button data-filter="all"
                        class="filter-btn active px-4 py-2 rounded-lg font-semibold transition">Alle</button>
                    <button data-filter="Erste Bank"
                        class="filter-btn px-4 py-2 rounded-lg font-semibold transition">Erste Bank</button>
                    <button data-filter="N26" class="filter-btn px-4 py-2 rounded-lg font-semibold transition">N26</button>
                    <button data-filter="Revolut"
                        class="filter-btn px-4 py-2 rounded-lg font-semibold transition">Revolut</button>
                </div>
            </div>

            <!-- Block 3: Kalender (nur Desktop) -->
            <div id="calendar-desktop-wrapper" class="card p-4 md:p-6 rounded-xl shadow-md hidden lg:flex flex-col">
                <div id="calendar-container-desktop" class="flex flex-col w-full h-full">
                    <div id="calendar-header-desktop" class="flex justify-between items-center mb-4 w-full">
                        <!-- Inhalt wird durch JS generiert -->
                    </div>
                    <div id="calendar-grid-desktop" class="grid grid-cols-7 gap-1 text-center flex-grow">
                        <!-- Inhalt wird durch JS generiert -->
                    </div>
                </div>
                <div class="text-center mt-4 w-full min-h-[40px]">
                    <button id="clear-date-filter-btn-desktop"
                        class="filter-btn hidden px-4 py-2 rounded-lg font-semibold transition">Datumsfilter
                        zurücksetzen</button>
                </div>
            </div>

            <!-- Block 4: Diagramme -->
            <!-- Ausgaben nach Kategorie -->
            <div class="card w-full p-4 md:p-6 rounded-xl shadow-md flex flex-col">
                <h2 class="text-xl font-bold text-center mb-4">Ausgaben nach Kategorie</h2>
                <div class="relative flex-grow h-64"><canvas id="ausgabenChart"></canvas></div>
            </div>
            <!-- Einnahmen nach Kategorie -->
            <div class="card w-full p-4 md:p-6 rounded-xl shadow-md flex flex-col">
                <h2 class="text-xl font-bold text-center mb-4">Einnahmen nach Kategorie</h2>
                <div class="relative flex-grow h-64"><canvas id="einnahmenChart"></canvas></div>
            </div>
            <!-- Ausgaben pro Konto -->
            <div class="card w-full p-4 md:p-6 rounded-xl shadow-md flex flex-col">
                <h2 class="text-xl font-bold text-center mb-4">Ausgaben pro Konto</h2>
                <div class="relative flex-grow h-64"><canvas id="kontoChart"></canvas></div>
            </div>
        </div>

        <!-- Linke Spalte (wird auf Mobile als letztes/unten angezeigt) -->
        <div class="lg:col-span-3 lg:order-1">
            <!-- 3. ZEILE: TRANSAKTIONSTABELLE -->
            <div class="w-full card p-4 md:p-6 rounded-xl shadow-md overflow-x-auto h-full flex flex-col">
                <div class="flex justify-between items-center flex-wrap gap-4 mb-4">
                    <div class="flex items-center gap-2 flex-wrap">
                        <h2 class="text-xl font-bold">Transaktionen</h2>
                        <button id="add-transaction-btn" title="Neue Transaktion hinzufügen"
                            class="filter-btn rounded-md font-semibold transition text-sm flex items-center justify-center w-9 h-9 md:w-auto md:h-auto md:p-2 md:gap-2">
                            <i data-lucide="plus" class="h-4 w-4"></i><span class="hidden md:inline">Neu</span>
                        </button>
                        <button id="import-csv-btn" title="Transaktionen aus CSV-Datei importieren"
                            class="filter-btn rounded-md font-semibold transition text-sm flex items-center justify-center w-9 h-9 md:w-auto md:h-auto md:p-2 md:gap-2">
                            <i data-lucide="file-down" class="h-4 w-4"></i><span class="hidden md:inline">Importieren</span>
                        </button>
                        <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                        <button id="export-csv-btn" title="Transaktionen sichern"
                            class="filter-btn rounded-md font-semibold transition text-sm flex items-center justify-center w-9 h-9 md:w-auto md:h-auto md:p-2 md:gap-2">
                            <i data-lucide="save" class="h-4 w-4"></i><span class="hidden md:inline">Backup</span>
                        </button>
                        <button id="delete-all-transactions-btn" title="Alle Transaktionen löschen"
                            class="filter-btn rounded-md font-semibold transition bg-red-500 hover:bg-red-600 text-white flex items-center justify-center w-9 h-9 md:p-2">
                            <i data-lucide="trash-2" class="h-4 w-4"></i>
                        </button>
                    </div>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><svg
                                class="w-5 h-5" style="color: var(--subtle-text);" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                            </svg></span>
                        <input type="text" id="transaction-search-input" placeholder="Transaktionen durchsuchen..."
                            class="w-full md:w-72 pl-10 pr-10 py-2 rounded-lg"
                            style="background-color: var(--bg-color); border: 1px solid var(--border-color);">
                        <button id="clear-search-btn"
                            class="hidden absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer"><svg
                                class="w-5 h-5" style="color: var(--subtle-text);" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                            </svg></button>
                    </div>
                </div>
                <div class="overflow-x-auto flex-grow">
                    <table class="w-full text-left responsive-table">
                        <thead class="subtle-text uppercase text-xs">
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <th class="p-3 table-header-sortable" data-sort="Datum">Datum</th>
                                <th class="p-3 table-header-sortable" data-sort="Betrag">Betrag</th>
                                <th class="p-3 table-header-sortable" data-sort="Beschreibung">Beschreibung</th>
                                <th class="p-3 table-header-sortable" data-sort="Kategorie">Kategorie</th>
                                <th class="p-3 table-header-sortable" data-sort="Konto">Konto</th>
                                <th class="p-3">Zahlungsmethode</th>
                                <th class="p-3 table-header-sortable" data-sort="Wiederkehrend">Wiederkehrend</th>
                                <th class="p-3 text-center">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-table-body" class="divide-y" style="border-color: var(--border-color);"></tbody>
                    </table>
                </div>
                <div id="pagination-controls" class="flex justify-between items-center mt-4 pt-4 border-t flex-shrink-0"
                    style="border-color: var(--border-color);"></div>
            </div>
        </div>
    </div>

    <!-- Modal zum Hinzufügen/Bearbeiten einer Transaktion -->
    <div id="transaction-modal-overlay"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-40 opacity-0 pointer-events-none transition-opacity duration-300">
    </div>
    <div id="transaction-modal" class="fixed z-50 opacity-0 pointer-events-none scale-95 transition-all duration-300">
        <div class="card p-4 sm:p-6 rounded-xl shadow-lg overflow-y-auto">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 id="modal-title" class="text-2xl font-bold">Neue Transaktion</h2>
                    <p class="subtle-text text-sm">Füge eine neue Buchung hinzu oder wähle eine Vorlage.</p>
                </div>
                <button id="close-modal-btn"
                    class="w-8 h-8 flex items-center justify-center rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 transition -mt-1 -mr-1">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <form id="transaction-form" class="space-y-6">
                <!-- VORLAGEN -->
                <details>
                    <summary class="flex justify-between items-center text-sm font-medium subtle-text mb-2 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
                        <span>Vorlage für Fixkosten</span>
                        <i data-lucide="chevron-right" class="icon h-5 w-5"></i>
                    </summary>
                    <div id="template-container" class="grid grid-cols-2 gap-2 mt-2">
                        <!-- Vorlagen werden hier per JS eingefügt -->
                    </div>
                    <p id="no-templates-message" class="hidden text-center subtle-text p-4 border-2 border-dashed rounded-lg mt-2">Keine Vorlagen gefunden.</p>
                </details>


                <!-- ART DER TRANSAKTION (TABS) -->
                <div>
                    <label class="block text-sm font-medium subtle-text mb-2">Art der Transaktion</label>
                    <div id="type-selector" class="flex items-center gap-2">
                        <input type="radio" id="trans-art-ausgabe" name="trans-art" value="Ausgabe" class="sr-only" checked>
                        <label for="trans-art-ausgabe" data-type="Ausgabe"
                            class="type-selector-btn p-3 rounded-lg cursor-pointer flex items-center justify-center gap-2">
                            <i data-lucide="arrow-down-circle" class="h-5 w-5"></i>
                            <span>Ausgabe</span>
                        </label>

                        <input type="radio" id="trans-art-einnahme" name="trans-art" value="Einnahme" class="sr-only">
                        <label for="trans-art-einnahme" data-type="Einnahme"
                            class="type-selector-btn p-3 rounded-lg cursor-pointer flex items-center justify-center gap-2">
                            <i data-lucide="arrow-up-circle" class="h-5 w-5"></i>
                            <span>Einnahme</span>
                        </label>

                        <input type="radio" id="trans-art-uberweisung" name="trans-art" value="Überweisung" class="sr-only">
                        <label for="trans-art-uberweisung" data-type="Überweisung"
                            class="type-selector-btn p-3 rounded-lg cursor-pointer flex items-center justify-center gap-2">
                            <i data-lucide="arrow-right-left" class="h-5 w-5"></i>
                            <span>Überweisung</span>
                        </label>
                    </div>
                </div>

                <!-- DATUM & BETRAG -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div class="md:col-span-2">
                        <label for="trans-datum-display" class="block text-sm font-medium subtle-text mb-1">Datum</label>
                        <div class="relative">
                            <input type="date" id="trans-datum" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer" aria-hidden="true" required>
                            <input type="text" id="trans-datum-display" placeholder="Datum auswählen" readonly class="form-input w-full p-2 rounded-lg pr-10 cursor-pointer">
                            <button type="button" id="open-date-picker-btn" class="absolute inset-y-0 right-0 flex items-center pr-3" title="Datum auswählen">
                                <i data-lucide="calendar" class="h-5 w-5 calendar-icon"></i>
                            </button>
                        </div>
                    </div>
                    <div class="md:col-span-3">
                        <label for="trans-betrag" class="block text-sm font-medium subtle-text mb-1">Betrag</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-lg subtle-text">€</span>
                            <input type="text" id="trans-betrag" required placeholder="0,00" class="form-input w-full p-2 pl-8 pr-3 rounded-lg text-xl font-bold">
                        </div>
                    </div>
                </div>

                <!-- BESCHREIBUNG -->
                <div>
                    <label for="trans-beschreibung" class="block text-sm font-medium subtle-text mb-1">Beschreibung</label>
                    <input type="text" id="trans-beschreibung" required placeholder="z.B. Wocheneinkauf bei Billa" class="form-input w-full p-2 rounded-lg">
                </div>

                <!-- STANDARD-FELDER (Kategorie, Konto) -->
                <div id="standard-fields-wrapper" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="trans-kategorie" class="block text-sm font-medium subtle-text mb-1">Kategorie</label>
                        <select id="trans-kategorie" required class="form-select w-full p-2 rounded-lg"></select>
                    </div>
                    <div>
                        <label for="trans-konto" class="block text-sm font-medium subtle-text mb-1">Konto</label>
                        <select id="trans-konto" required class="form-select w-full p-2 rounded-lg transition-opacity">
                            <option>Erste Bank</option>
                            <option>N26</option>
                            <option>Revolut</option>
                        </select>
                    </div>
                </div>

                <!-- ÜBERWEISUNGS-FELDER -->
                <div id="transfer-fields-wrapper" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="trans-konto-von" class="block text-sm font-medium subtle-text mb-1">Von Konto</label>
                        <select id="trans-konto-von" class="form-select w-full p-2 rounded-lg">
                            <option>Erste Bank</option>
                            <option>N26</option>
                            <option>Revolut</option>
                        </select>
                    </div>
                    <div>
                        <label for="trans-konto-zu" class="block text-sm font-medium subtle-text mb-1">Zu Konto</label>
                        <select id="trans-konto-zu" class="form-select w-full p-2 rounded-lg">
                            <option>Erste Bank</option>
                            <option>N26</option>
                            <option>Revolut</option>
                        </select>
                    </div>
                </div>

                <!-- ZAHLUNGSMETHODE & WIEDERKEHREND -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                    <div id="payment-method-wrapper">
                        <label class="block text-sm font-medium subtle-text mb-2">Zahlungsmethode</label>
                        <div class="flex items-center gap-2 payment-method-radio-group">
                            <input type="radio" id="trans-zahlungsmethode-karte" name="trans-zahlungsmethode" value="Karte" checked class="sr-only">
                            <label for="trans-zahlungsmethode-karte" class="p-2 rounded-lg cursor-pointer flex-1 text-center">Karte</label>
                            <input type="radio" id="trans-zahlungsmethode-bar" name="trans-zahlungsmethode" value="Bar" class="sr-only">
                            <label for="trans-zahlungsmethode-bar" class="p-2 rounded-lg cursor-pointer flex-1 text-center">Bar</label>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 pt-6">
                        <input type="checkbox" id="trans-wiederkehrend" class="h-5 w-5 rounded" style="border-color: var(--border-color);">
                        <label for="trans-wiederkehrend" class="text-sm font-medium">Als wiederkehrende Vorlage speichern</label>
                    </div>
                </div>

                <!-- SONSTIGE INFOS -->
                <div>
                    <label for="trans-sonstige-infos" class="block text-sm font-medium subtle-text mb-1">Sonstige Infos</label>
                    <textarea id="trans-sonstige-infos" rows="2" placeholder="Zusätzliche Notizen, Rechnungsnummer etc." class="form-input w-full p-2 rounded-lg"></textarea>
                </div>

                <!-- SPEICHERN-BUTTON -->
                <div class="pt-4">
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition flex items-center justify-center gap-2">
                        <i data-lucide="check-circle" class="h-5 w-5"></i>
                        <span>Transaktion speichern</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bestätigungs-Modal -->
    <div id="confirm-modal-overlay"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-40 opacity-0 pointer-events-none transition-opacity duration-300">
    </div>
    <div id="confirm-modal"
        class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-md z-50 opacity-0 pointer-events-none scale-95 transition-all duration-300">
        <div class="card p-6 rounded-xl shadow-lg">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4">Aktion bestätigen</h3>
            <p id="confirm-modal-text" class="mb-6">Möchten Sie diese Aktion wirklich ausführen?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel-btn"
                    class="filter-btn px-4 py-2 rounded-lg font-semibold transition">Abbrechen</button>
                <button id="confirm-modal-confirm-btn"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">Löschen</button>
            </div>
        </div>
    </div>

    <!-- MODAL FÜR BACKUP-DATEINAMEN -->
    <div id="backup-name-modal-overlay"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-40 opacity-0 pointer-events-none transition-opacity duration-300">
    </div>
    <div id="backup-name-modal"
        class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-md z-50 opacity-0 pointer-events-none scale-95 transition-all duration-300">
        <div class="card p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-bold mb-4">Backup-Dateinamen eingeben</h3>
            <input type="text" id="backup-filename-input" class="w-full p-2 rounded-lg mb-4"
                style="background-color: var(--bg-color); border: 1px solid var(--border-color);"
                placeholder="z.B. aurimea-backup-2024-07-01">
            <div class="flex justify-end gap-4">
                <button id="backup-name-cancel-btn"
                    class="filter-btn px-4 py-2 rounded-lg font-semibold transition">Abbrechen</button>
                <button id="backup-name-confirm-btn"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">Download</button>
            </div>
        </div>
    </div>

    <!-- MODAL FÜR SONSTIGE INFOS -->
    <div id="info-modal-overlay"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-40 opacity-0 pointer-events-none transition-opacity duration-300">
    </div>
    <div id="info-modal"
        class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-lg z-50 opacity-0 pointer-events-none scale-95 transition-all duration-300">
        <div class="card p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Zusätzliche Informationen</h3>
                <button id="info-modal-close-btn"
                    class="w-8 h-8 flex items-center justify-center rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="info-modal-content" class="subtle-text whitespace-pre-wrap break-words max-h-[60vh] overflow-y-auto">
                <!-- Inhalt wird durch JS eingefügt -->
            </div>
        </div>
    </div>

    <!-- Benachrichtigungs-Element -->
    <div id="notification"
        class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 pointer-events-none transition-all duration-300 -translate-y-12">
        <p id="notification-message"></p>
    </div>

    <!-- Kalender Seitenleiste (Mobile) -->
    <div id="calendar-sidebar-overlay"
        class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-40 opacity-0 pointer-events-none transition-opacity duration-300 lg:hidden">
    </div>
    <div id="calendar-sidebar"
        class="fixed top-0 right-0 h-full w-full max-w-sm shadow-xl z-50 transform translate-x-full transition-transform duration-300 lg:hidden"
        style="background-color: var(--card-bg);">
        <div class="p-4 md:p-6 flex flex-col h-full">
            <div class="flex justify-between items-center mb-4 w-full flex-shrink-0">
                <h3 class="text-xl font-bold" style="color: var(--text-color);">Kalender</h3>
                <button id="close-calendar-sidebar-btn"
                    class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="calendar-header-mobile" class="flex justify-between items-center mb-4 w-full flex-shrink-0"></div>
            <div id="calendar-grid-mobile" class="grid grid-cols-7 gap-1 text-center flex-grow"></div>
            <div class="text-center mt-4 w-full min-h-[40px] flex-shrink-0">
                <button id="clear-date-filter-btn-mobile"
                    class="filter-btn hidden px-4 py-2 rounded-lg font-semibold transition">Datumsfilter
                    zurücksetzen</button>
            </div>
        </div>
    </div>

    <!-- Schwebende Aktionsbuttons -->
    <button id="fab-open-dashboard" title="Dashboard anzeigen"
        class="lg:hidden fixed right-6 bg-blue-600 hover:bg-blue-700 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg z-30 transition-transform transform hover:scale-110 active:scale-100"
        style="bottom: calc(10.5rem + env(safe-area-inset-bottom));">
        <i data-lucide="layout-dashboard" class="h-7 w-7"></i>
    </button>
    <button id="fab-open-calendar" title="Kalender anzeigen"
        class="lg:hidden fixed right-6 bg-purple-600 hover:bg-purple-700 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg z-30 transition-transform transform hover:scale-110 active:scale-100">
        <i data-lucide="calendar" class="h-7 w-7"></i>
    </button>
    <button id="fab-add-transaction" title="Neue Transaktion hinzufügen"
        class="fixed right-6 bg-indigo-600 hover:bg-indigo-700 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg z-30 transition-transform transform hover:scale-110 active:scale-100">
        <i data-lucide="plus" class="h-8 w-8"></i>
    </button>


    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT & KATEGORIEN ---
            let allTransactions = [];
            let recurringTemplates = [];
            let searchTerm = '';
            let currentFilter = 'all';
            let selectedDate = null;
            let calendarDate = new Date();
            let sortConfig = {
                key: 'Datum',
                direction: 'desc'
            };
            let charts = {
                ausgaben: null,
                einnahmen: null,
                konto: null
            };
            let transactionDates = new Set();
            let currentPage = 1;
            const itemsPerPage = 25;
            const formatCurrency = (value) => new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR'
            }).format(value);
            const TRANSACTIONS_STORAGE_KEY = 'aurimea-transactions';
            const TEMPLATES_STORAGE_KEY = 'aurimea-recurring-templates';

            const expenseCategories = ['Lebensmittel', 'Wohnen', 'Transport', 'Freizeit', 'Gesundheit', 'Kleidung', 'Rechnungen', 'Versicherung', 'Sonstiges'];
            const incomeCategories = ['Gehalt', 'Bonus', 'Geschenk', 'Verkauf', 'Sonstiges'];


            // --- MODAL & NOTIFICATION ELEMENTS ---
            const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmModalTitle = document.getElementById('confirm-modal-title');
            const confirmModalText = document.getElementById('confirm-modal-text');
            const confirmCancelBtn = document.getElementById('confirm-modal-cancel-btn');
            const confirmConfirmBtn = document.getElementById('confirm-modal-confirm-btn');
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            let confirmCallback = null;

            const backupNameModalOverlay = document.getElementById('backup-name-modal-overlay');
            const backupNameModal = document.getElementById('backup-name-modal');
            const backupFilenameInput = document.getElementById('backup-filename-input');
            const backupNameCancelBtn = document.getElementById('backup-name-cancel-btn');
            const backupNameConfirmBtn = document.getElementById('backup-name-confirm-btn');

            const infoModalOverlay = document.getElementById('info-modal-overlay');
            const infoModal = document.getElementById('info-modal');
            const infoModalContent = document.getElementById('info-modal-content');
            const infoModalCloseBtn = document.getElementById('info-modal-close-btn');


            // --- DATA HANDLING ---
            function loadData() {
                // 1. Lade bestehende Transaktionen
                const storedTransactions = localStorage.getItem(TRANSACTIONS_STORAGE_KEY);
                try {
                    allTransactions = storedTransactions ? JSON.parse(storedTransactions) : [];
                    allTransactions.forEach(t => {
                        if (!t.id) t.id = crypto.randomUUID();
                        if (t.parsedDate) {
                            t.Datum = formatGermanDate(t.parsedDate);
                        }
                    });
                    saveTransactions(); // Speichert die Daten mit ggf. neuen IDs
                } catch (e) {
                    console.error("Fehler beim Laden der Transaktionen:", e);
                    allTransactions = [];
                }
                transactionDates = new Set(allTransactions.map(t => t.parsedDate).filter(d => d && d.length === 10));

                // 2. Lade explizit gespeicherte Vorlagen
                const storedTemplates = localStorage.getItem(TEMPLATES_STORAGE_KEY);
                try {
                    recurringTemplates = storedTemplates ? JSON.parse(storedTemplates) : [];
                } catch (e) {
                    console.error("Fehler beim Laden der Vorlagen:", e);
                    recurringTemplates = [];
                }

                // --- NEUE LOGIK START ---
                // 3. Erstelle ein Set, um doppelte Vorlagen zu vermeiden
                // Wir nutzen stringify, um Objekte vergleichbar zu machen
                const uniqueTemplates = new Set(recurringTemplates.map(t => JSON.stringify(t)));

                // 4. Durchsuche alle Transaktionen nach wiederkehrenden Zahlungen
                allTransactions.forEach(transaction => {
                    // Überweisungen ausschließen, da sie eine spezielle Logik haben
                    if (transaction.Wiederkehrend === 'Ja' && transaction.Art !== 'Überweisung') {
                        const templateData = {
                            Beschreibung: transaction.Beschreibung,
                            Betrag: transaction.Betrag,
                            Art: transaction.Art,
                            Kategorie: transaction.Kategorie,
                            Konto: transaction.Konto,
                            Zahlungsmethode: transaction.Zahlungsmethode,
                        };
                        uniqueTemplates.add(JSON.stringify(templateData));
                    }
                });

                // 5. Wandle das Set zurück in ein Array von Objekten um
                recurringTemplates = Array.from(uniqueTemplates).map(str => JSON.parse(str));

                // Optional: Die konsolidierte Liste zurückspeichern, um sie für die Zukunft zu optimieren
                saveTemplates();
                // --- NEUE LOGIK ENDE ---
            }

            function saveTransactions() {
                localStorage.setItem(TRANSACTIONS_STORAGE_KEY, JSON.stringify(allTransactions));
            }

            function saveTemplates() {
                localStorage.setItem(TEMPLATES_STORAGE_KEY, JSON.stringify(recurringTemplates));
            }

            // --- MAIN UPDATE FUNCTION ---
            function updateDashboard() {
                const accountFilteredData = (currentFilter === 'all') ? allTransactions : allTransactions.filter(row => row.Konto === currentFilter);
                const financialSummary = processData(accountFilteredData);
                updateSummaryCards(financialSummary);
                createOrUpdateCharts(financialSummary);
                let tableData = [...accountFilteredData];
                if (selectedDate) {
                    tableData = tableData.filter(row => row.parsedDate === selectedDate);
                }
                if (searchTerm) {
                    const lowerCaseSearchTerm = searchTerm.toLowerCase();
                    tableData = tableData.filter(row => {
                        const displayKategorie = (row.Wiederkehrend === 'Ja' ? 'fixkosten' : (row.Kategorie || '')).toLowerCase();
                        const formattedBetrag = formatCurrency(row.Betrag).replace(/\./g, '').toLowerCase();
                        return Object.values(row).some(val => String(val).toLowerCase().includes(lowerCaseSearchTerm)) || displayKategorie.includes(lowerCaseSearchTerm) || formattedBetrag.includes(lowerCaseSearchTerm);
                    });
                }
                sortData(tableData);
                const paginatedData = tableData.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
                renderTransactionTable(paginatedData);
                renderPaginationControls(tableData.length);
            }

            // --- SORTING ---
            function sortData(data) {
                data.sort((a, b) => {
                    let aValue = a[sortConfig.key];
                    let bValue = b[sortConfig.key];
                    if (sortConfig.key === 'Datum') {
                        aValue = a.parsedDate;
                        bValue = b.parsedDate;
                    }
                    if (sortConfig.key === 'Betrag') {
                        aValue = a.Betrag;
                        bValue = b.Betrag;
                    }
                    if (aValue < bValue) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (aValue > bValue) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // --- DATA PROCESSING ---
            function processData(data) {
                const summary = {
                    ausgabenByCat: {},
                    einnahmenByCat: {},
                    ausgabenByKonto: {},
                    totalAusgaben: 0,
                    totalEinnahmen: 0
                };
                const kontoSummary = {};
                allTransactions.forEach(row => {
                    if (row.Art === 'Ausgabe' && row.Konto) {
                        kontoSummary[row.Konto] = (kontoSummary[row.Konto] || 0) + row.Betrag;
                    }
                });
                summary.ausgabenByKonto = kontoSummary;

                data.forEach(row => {
                    if (row.Art === 'Ausgabe') {
                        if (row.Kategorie !== 'Überweisung') {
                            summary.ausgabenByCat[row.Kategorie] = (summary.ausgabenByCat[row.Kategorie] || 0) + row.Betrag;
                        }
                        summary.totalAusgaben += row.Betrag;
                    } else if (row.Art === 'Einnahme') {
                        if (row.Kategorie !== 'Überweisung') {
                            summary.einnahmenByCat[row.Kategorie] = (summary.einnahmenByCat[row.Kategorie] || 0) + row.Betrag;
                        }
                        summary.totalEinnahmen += row.Betrag;
                    }
                });
                return summary;
            }

            // --- UI RENDERING ---
            function updateSummaryCards(summary) {
                const bilanz = summary.totalEinnahmen - summary.totalAusgaben;
                document.getElementById('total-einnahmen').textContent = formatCurrency(summary.totalEinnahmen);
                document.getElementById('total-ausgaben').textContent = formatCurrency(summary.totalAusgaben);
                const bilanzEl = document.getElementById('bilanz');
                bilanzEl.textContent = formatCurrency(bilanz);
                bilanzEl.className = `text-2xl font-bold ${bilanz >= 0 ? 'text-green-500' : 'text-red-500'}`;
            }

            function renderTransactionTable(data) {
                const tbody = document.getElementById('transaction-table-body');
                tbody.innerHTML = '';
                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="10" class="text-center p-4 subtle-text">Keine Transaktionen gefunden.</td></tr>`;
                    return;
                }
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = 'text-sm border-b';
                    tr.style.borderColor = 'var(--border-color)';

                    let betragClass = '';
                    if (row.Kategorie === 'Überweisung') {
                        betragClass = 'text-blue-500';
                    } else if (row.Art === 'Einnahme') {
                        betragClass = 'text-green-500';
                    } else {
                        betragClass = 'text-red-500';
                    }

                    tr.innerHTML = `
                        <td data-label="Datum" class="p-3">${row.Datum || ''}</td>
                        <td class="${betragClass} font-semibold p-3" data-label="Betrag">${formatCurrency(row.Betrag)}</td>
                        <td data-label="Beschreibung" class="p-3">${row.Beschreibung || ''}</td>
                        <td data-label="Kategorie" class="p-3">${row.Kategorie || ''}</td>
                        <td data-label="Konto" class="p-3">${row.Konto || ''}</td>
                        <td data-label="Zahlungsmethode" class="p-3">${row.Zahlungsmethode || ''}</td>
                        <td data-label="Wiederkehrend" class="p-3">${row.Wiederkehrend || ''}</td>
                        <td data-label="Aktionen" class="p-3">
                            <div class="flex justify-end items-center gap-2">
                                ${row['Sonstige Infos'] ? `<button class="action-btn info-btn" data-info="${row['Sonstige Infos']}" title="Zusätzliche Infos anzeigen">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                                </button>` : ''}
                               <button class="action-btn edit-btn" data-id="${row.id}" title="Transaktion bearbeiten">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                </button>
                               <button class="action-btn delete-btn" data-id="${row.id}" title="Transaktion löschen">
                                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            function createOrUpdateCharts(summary) {
                const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
                const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim() + '80';
                const chartColors = {
                    ausgaben: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#f43f5e'],
                    einnahmen: ['#22c55e', '#16a34a', '#15803d', '#10b285'],
                    konto: ['#3b82f6', '#8b5cf6', '#ec4899', '#6366f1']
                };
                const doughnutOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: textColor
                            }
                        }
                    }
                };
                const barOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            }
                        },
                        x: {
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            }
                        }
                    }
                };
                const createChart = (id, type, data, options, colors) => {
                    if (charts[id]) charts[id].destroy();
                    const canvas = document.getElementById(id + 'Chart');
                    if (!canvas) return;
                    charts[id] = new Chart(canvas.getContext('2d'), {
                        type,
                        data: {
                            labels: Object.keys(data),
                            datasets: [{
                                data: Object.values(data),
                                backgroundColor: colors,
                                borderWidth: 0
                            }]
                        },
                        options
                    });
                };
                createChart('ausgaben', 'doughnut', summary.ausgabenByCat, doughnutOptions, chartColors.ausgaben);
                createChart('einnahmen', 'doughnut', summary.einnahmenByCat, doughnutOptions, chartColors.einnahmen);
                createChart('konto', 'bar', summary.ausgabenByKonto, barOptions, chartColors.konto);
            }

            function renderPaginationControls(totalItems) {
                const paginationControls = document.getElementById('pagination-controls');
                paginationControls.innerHTML = '';
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                if (totalPages <= 1) return;
                const startItem = (currentPage - 1) * itemsPerPage + 1;
                const endItem = Math.min(currentPage * itemsPerPage, totalItems);
                paginationControls.innerHTML = `<span class="text-sm subtle-text">Zeige ${startItem}–${endItem} von ${totalItems}</span><div class="flex items-center gap-2"><button id="prev-page-btn" class="filter-btn px-3 py-1 rounded-md font-semibold transition text-sm">Zurück</button><span class="text-sm subtle-text font-semibold px-2">Seite ${currentPage} von ${totalPages}</span><button id="next-page-btn" class="filter-btn px-3 py-1 rounded-md font-semibold transition text-sm">Weiter</button></div>`;
                const prevBtn = document.getElementById('prev-page-btn');
                const nextBtn = document.getElementById('next-page-btn');
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;
                if (prevBtn.disabled) prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
                if (nextBtn.disabled) nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
                prevBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        updateDashboard();
                    }
                });
                nextBtn.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        updateDashboard();
                    }
                });
            }

            // --- KALENDER LOGIC ---
            const calendarGridDesktop = document.getElementById('calendar-grid-desktop');
            const calendarHeaderDesktop = document.getElementById('calendar-header-desktop');
            const calendarGridMobile = document.getElementById('calendar-grid-mobile');
            const calendarHeaderMobile = document.getElementById('calendar-header-mobile');

            function renderCalendar() {
                const targets = [{
                    grid: calendarGridDesktop,
                    header: calendarHeaderDesktop
                }, {
                    grid: calendarGridMobile,
                    header: calendarHeaderMobile
                }];
                const month = calendarDate.getMonth(),
                    year = calendarDate.getFullYear();
                const monthName = new Intl.DateTimeFormat('de-DE', {
                    month: 'long',
                    year: 'numeric'
                }).format(calendarDate);
                const todayStr = new Date().toISOString().slice(0, 10);

                targets.forEach(target => {
                    if (!target.grid || !target.header) return;

                    target.grid.innerHTML = '';
                    target.header.innerHTML = `
                        <button data-action="prev-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                        <h3 class="text-lg font-semibold text-center w-48">${monthName}</h3>
                        <button data-action="next-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                    `;

                    ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'].forEach(day => {
                        const el = document.createElement('div');
                        el.className = 'font-bold subtle-text text-sm h-9 flex items-center justify-center';
                        el.textContent = day;
                        target.grid.appendChild(el);
                    });

                    const firstDayOfMonth = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const startOffset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
                    for (let i = 0; i < startOffset; i++) {
                        target.grid.appendChild(document.createElement('div'));
                    }

                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayButton = document.createElement('button');
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        dayButton.dataset.date = dateStr;
                        dayButton.textContent = day;
                        dayButton.className = 'calendar-day text-sm';
                        if (transactionDates.has(dateStr)) dayButton.classList.add('has-transactions');
                        if (dateStr === todayStr) dayButton.classList.add('today');
                        if (dateStr === selectedDate) dayButton.classList.add('selected');
                        dayButton.addEventListener('click', handleDateClick);
                        target.grid.appendChild(dayButton);
                    }
                });

                document.querySelectorAll('[data-action="prev-month"]').forEach(btn => btn.addEventListener('click', () => {
                    calendarDate.setMonth(calendarDate.getMonth() - 1);
                    renderCalendar();
                }));
                document.querySelectorAll('[data-action="next-month"]').forEach(btn => btn.addEventListener('click', () => {
                    calendarDate.setMonth(calendarDate.getMonth() + 1);
                    renderCalendar();
                }));

                lucide.createIcons();
            }

            function handleDateClick(e) {
                const clickedDate = e.currentTarget.dataset.date;
                currentPage = 1;
                selectedDate = (selectedDate === clickedDate) ? null : clickedDate;

                const clearBtnDesktop = document.getElementById('clear-date-filter-btn-desktop');
                const clearBtnMobile = document.getElementById('clear-date-filter-btn-mobile');
                clearBtnDesktop.classList.toggle('hidden', !selectedDate);
                clearBtnMobile.classList.toggle('hidden', !selectedDate);

                renderCalendar();
                updateDashboard();
                closeCalendarSidebar();
            }

            // --- CSV IMPORT / BACKUP ---
            function importFromCSV(file) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        let importedCount = 0;
                        results.data.forEach(row => {
                            if (!row.Datum || !row.Betrag || !row.Art) {
                                console.warn("Skipping invalid row:", row);
                                return;
                            }
                            const dateParts = row.Datum.split('.');
                            const parsedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
                            const newTransaction = {
                                id: crypto.randomUUID(),
                                'Datum': row.Datum,
                                'Art': row.Art,
                                'Betrag': parseFloat(String(row.Betrag).replace(',', '.')),
                                'Beschreibung': row.Beschreibung || '',
                                'Kategorie': row.Kategorie || '',
                                'Konto': row.Konto || '',
                                'Zahlungsmethode': row.Zahlungsmethode || '',
                                'Wiederkehrend': row.Wiederkehrend === 'Ja' ? 'Ja' : 'Nein',
                                'parsedDate': parsedDate,
                                'Sonstige Infos': row['Sonstige Infos'] || ''
                            };
                            allTransactions.push(newTransaction);
                            transactionDates.add(newTransaction.parsedDate);
                            importedCount++;
                        });
                        if (importedCount > 0) {
                            saveTransactions();
                            updateDashboard();
                            renderCalendar();
                            showNotification(`${importedCount} Transaktionen erfolgreich importiert!`);
                        } else {
                            showNotification("Keine gültigen Transaktionen in der Datei gefunden.");
                        }
                    },
                    error: (err) => {
                        showNotification("Fehler beim Parsen der CSV-Datei.");
                        console.error("CSV Parse Error:", err);
                    }
                });
            }

            function createJsonBackup() {
                const dataStr = JSON.stringify(allTransactions, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const today = new Date();
                const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                const defaultFilename = `aurimea-backup-${dateString}.json`;

                backupFilenameInput.value = defaultFilename;
                openBackupNameModal();
            }

            // --- CONFIRMATION MODAL & NOTIFICATION LOGIC ---
            function showNotification(message, duration = 3000) {
                notificationMessage.textContent = message;
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, duration);
            }

            function openConfirmModal(title, text, onConfirm) {
                confirmModalTitle.textContent = title;
                confirmModalText.textContent = text;
                confirmCallback = onConfirm;
                confirmModalOverlay.classList.remove('opacity-0', 'pointer-events-none');
                confirmModal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
            }

            function closeConfirmModal() {
                confirmModalOverlay.classList.add('opacity-0', 'pointer-events-none');
                confirmModal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                confirmCallback = null;
            }

            confirmCancelBtn.addEventListener('click', closeConfirmModal);
            confirmConfirmBtn.addEventListener('click', () => {
                if (typeof confirmCallback === 'function') {
                    confirmCallback();
                }
                closeConfirmModal();
            });
            confirmModalOverlay.addEventListener('click', closeConfirmModal);

            function openBackupNameModal() {
                backupNameModalOverlay.classList.remove('opacity-0', 'pointer-events-none');
                backupNameModal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                backupFilenameInput.focus();
            }

            function closeBackupNameModal() {
                backupNameModalOverlay.classList.add('opacity-0', 'pointer-events-none');
                backupNameModal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
            }

            backupNameCancelBtn.addEventListener('click', closeBackupNameModal);
            backupNameConfirmBtn.addEventListener('click', () => {
                const filename = backupFilenameInput.value.trim();
                if (filename) {
                    const dataStr = JSON.stringify(allTransactions, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showNotification('Backup erfolgreich heruntergeladen!');
                    closeBackupNameModal();
                } else {
                    showNotification('Bitte geben Sie einen Dateinamen ein.', 3000);
                }
            });
            backupNameModalOverlay.addEventListener('click', closeBackupNameModal);


            // --- EVENT LISTENERS ---
            document.getElementById('transaction-search-input').addEventListener('input', (e) => {
                currentPage = 1;
                searchTerm = e.target.value;
                document.getElementById('clear-search-btn').classList.toggle('hidden', !searchTerm);
                updateDashboard();
            });
            document.getElementById('clear-search-btn').addEventListener('click', () => {
                currentPage = 1;
                document.getElementById('transaction-search-input').value = '';
                searchTerm = '';
                document.getElementById('clear-search-btn').classList.add('hidden');
                updateDashboard();
            });
            document.getElementById('account-filter').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    currentPage = 1;
                    currentFilter = e.target.dataset.filter;
                    document.querySelectorAll('#account-filter button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    updateDashboard();
                }
            });
            document.querySelectorAll('.table-header-sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const key = header.dataset.sort;
                    currentPage = 1;
                    sortConfig.direction = (sortConfig.key === key && sortConfig.direction === 'asc') ? 'desc' : 'asc';
                    sortConfig.key = key;
                    updateDashboard();
                });
            });

            const clearFilterAction = () => {
                selectedDate = null;
                currentPage = 1;
                document.getElementById('clear-date-filter-btn-desktop').classList.add('hidden');
                document.getElementById('clear-date-filter-btn-mobile').classList.add('hidden');
                renderCalendar();
                updateDashboard();
            };
            document.getElementById('clear-date-filter-btn-desktop').addEventListener('click', clearFilterAction);
            document.getElementById('clear-date-filter-btn-mobile').addEventListener('click', clearFilterAction);

            document.getElementById('import-csv-btn').addEventListener('click', () => document.getElementById('csv-file-input').click());
            document.getElementById('csv-file-input').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importFromCSV(e.target.files[0]);
                }
            });
            document.getElementById('export-csv-btn').addEventListener('click', createJsonBackup);

            document.getElementById('delete-all-transactions-btn').addEventListener('click', () => {
                openConfirmModal(
                    'Alle Daten löschen',
                    'Möchten Sie WIRKLICH ALLE Transaktionen UND Vorlagen unwiderruflich löschen?',
                    () => {
                        allTransactions = [];
                        recurringTemplates = [];
                        transactionDates = new Set();
                        saveTransactions();
                        saveTemplates();
                        updateDashboard();
                        renderCalendar();
                        showNotification('Alle Daten wurden erfolgreich gelöscht.');
                    }
                );
            });

            document.getElementById('transaction-table-body').addEventListener('click', (e) => {
                const editButton = e.target.closest('.edit-btn');
                const deleteButton = e.target.closest('.delete-btn');
                const infoButton = e.target.closest('.info-btn');

                if (infoButton) {
                    const infoText = infoButton.dataset.info;
                    openInfoModal(infoText);
                } else if (editButton) {
                    openModal(editButton.dataset.id);
                } else if (deleteButton) {
                    openConfirmModal(
                        'Transaktion löschen',
                        'Möchten Sie diese Transaktion wirklich löschen?',
                        () => {
                            const idToDelete = deleteButton.dataset.id;
                            allTransactions = allTransactions.filter(t => t.id !== idToDelete);
                            transactionDates = new Set(allTransactions.map(t => t.parsedDate));
                            saveTransactions();
                            updateDashboard();
                            renderCalendar();
                            showNotification('Transaktion gelöscht.');
                        }
                    );
                }
            });

            // --- INFO MODAL LOGIC ---
            function openInfoModal(infoText) {
                infoModalContent.textContent = infoText;
                infoModalOverlay.classList.remove('opacity-0', 'pointer-events-none');
                infoModal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                lucide.createIcons();
            }

            function closeInfoModal() {
                infoModalOverlay.classList.add('opacity-0', 'pointer-events-none');
                infoModal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
            }

            infoModalCloseBtn.addEventListener('click', closeInfoModal);
            infoModalOverlay.addEventListener('click', closeInfoModal);


            // --- TRANSACTION MODAL LOGIC (ADD/EDIT) ---
            const modal = document.getElementById('transaction-modal');
            const modalOverlay = document.getElementById('transaction-modal-overlay');
            const modalForm = document.getElementById('transaction-form');
            const modalTitle = document.getElementById('modal-title');
            const transKategorieSelect = document.getElementById('trans-kategorie');
            const transKontoSelect = document.getElementById('trans-konto');
            const paymentMethodRadios = document.querySelectorAll('input[name="trans-zahlungsmethode"]');
            const transDatumInput = document.getElementById('trans-datum');
            const transDatumDisplay = document.getElementById('trans-datum-display');
            const openDatePickerBtn = document.getElementById('open-date-picker-btn');
            const transBetragInput = document.getElementById('trans-betrag');

            const standardFieldsWrapper = document.getElementById('standard-fields-wrapper');
            const transferFieldsWrapper = document.getElementById('transfer-fields-wrapper');
            const paymentMethodWrapper = document.getElementById('payment-method-wrapper');
            const transKontoVonSelect = document.getElementById('trans-konto-von');
            const transKontoZuSelect = document.getElementById('trans-konto-zu');

            const typeSelector = document.getElementById('type-selector');
            const typeSelectorBtns = document.querySelectorAll('.type-selector-btn');


            function handlePaymentMethodChange() {
                const isCash = document.getElementById('trans-zahlungsmethode-bar').checked;
                transKontoSelect.disabled = isCash;
                if (isCash) {
                    transKontoSelect.value = '';
                    transKontoSelect.classList.add('opacity-50', 'cursor-not-allowed');
                    transKontoSelect.required = false;
                } else {
                    transKontoSelect.classList.remove('opacity-50', 'cursor-not-allowed');
                    transKontoSelect.required = true;
                    if (!transKontoSelect.value && transKontoSelect.options.length > 0) {
                        transKontoSelect.value = transKontoSelect.options[0].value;
                    }
                }
            }

            paymentMethodRadios.forEach(radio => radio.addEventListener('change', handlePaymentMethodChange));

            function updateCategoryOptions() {
                const selectedArt = document.querySelector('input[name="trans-art"]:checked').value;
                const categories = selectedArt === 'Ausgabe' ? expenseCategories : incomeCategories;
                transKategorieSelect.innerHTML = '';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    transKategorieSelect.appendChild(option);
                });
            }

            function handleArtChange() {
                const selectedArt = document.querySelector('input[name="trans-art"]:checked').value;

                // Update active button style
                typeSelectorBtns.forEach(btn => {
                    const label = btn.closest('label');
                    if (label) {
                        label.classList.toggle('active', label.dataset.type === selectedArt);
                    }
                });


                if (selectedArt === 'Überweisung') {
                    standardFieldsWrapper.classList.add('hidden');
                    transferFieldsWrapper.classList.remove('hidden');
                    paymentMethodWrapper.classList.add('hidden');
                    transKategorieSelect.required = false;
                    transKontoSelect.required = false;
                    transKontoVonSelect.required = true;
                    transKontoZuSelect.required = true;
                } else {
                    standardFieldsWrapper.classList.remove('hidden');
                    transferFieldsWrapper.classList.add('hidden');
                    paymentMethodWrapper.classList.remove('hidden');
                    transKategorieSelect.required = true;
                    transKontoSelect.required = !document.getElementById('trans-zahlungsmethode-bar').checked;
                    transKontoVonSelect.required = false;
                    transKontoZuSelect.required = false;
                    updateCategoryOptions();
                }
                lucide.createIcons();
            }

            typeSelector.addEventListener('change', handleArtChange);


            function formatGermanDate(isoDateString) {
                if (!isoDateString) return '';
                const date = new Date(isoDateString + 'T00:00:00');
                const kanjiDays = ['日', '月', '火', '水', '木', '金', '土'];
                const dayIndex = date.getDay();
                const kanjiDay = kanjiDays[dayIndex];
                const options = {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                };
                const dateString = new Intl.DateTimeFormat('de-DE', options).format(date);
                return `${kanjiDay} ${dateString}`;
            }

            function renderTemplates() {
                const container = document.getElementById('template-container');
                const noTemplatesMsg = document.getElementById('no-templates-message');
                container.innerHTML = '';

                if (recurringTemplates.length === 0) {
                    noTemplatesMsg.classList.remove('hidden');
                    container.classList.add('hidden');
                    return;
                }

                noTemplatesMsg.classList.add('hidden');
                container.classList.remove('hidden');

                recurringTemplates.forEach((template, index) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'template-btn';
                    btn.dataset.index = index;

                    let artIcon, artColor;
                    if (template.Art === 'Ausgabe') {
                        artIcon = 'arrow-down';
                        artColor = 'text-red-500';
                    } else if (template.Art === 'Einnahme') {
                        artIcon = 'arrow-up';
                        artColor = 'text-green-500';
                    } else { // Überweisung
                        artIcon = 'arrow-right-left';
                        artColor = 'text-blue-500';
                    }

                    btn.innerHTML = `
                        <button type="button" class="delete-template" data-index="${index}" title="Vorlage löschen">
                            <i data-lucide="x" class="w-4 h-4 pointer-events-none"></i>
                        </button>
                        <div class="flex items-center gap-2 mb-1">
                            <i data-lucide="${artIcon}" class="w-4 h-4 ${artColor} flex-shrink-0"></i>
                            <span class="font-bold truncate">${template.Beschreibung}</span>
                        </div>
                        <div class="text-sm subtle-text">${formatCurrency(template.Betrag)}</div>
                        <div class="text-xs subtle-text truncate">${template.Kategorie || ''} | ${template.Konto || ''}</div>
                    `;
                    container.appendChild(btn);
                });
                lucide.createIcons();
            }


            document.getElementById('template-container').addEventListener('click', (e) => {
                const templateBtn = e.target.closest('.template-btn');
                const deleteBtn = e.target.closest('.delete-template');

                if (deleteBtn) {
                    e.stopPropagation();
                    const templateIndex = deleteBtn.dataset.index;
                    const template = recurringTemplates[templateIndex];
                    openConfirmModal(
                        'Vorlage löschen',
                        `Möchten Sie die Vorlage "${template.Beschreibung}" wirklich löschen?`,
                        () => {
                            recurringTemplates.splice(templateIndex, 1);
                            saveTemplates();
                            renderTemplates();
                            showNotification('Vorlage erfolgreich gelöscht.');
                        }
                    );
                } else if (templateBtn) {
                    const templateIndex = templateBtn.dataset.index;
                    const template = recurringTemplates[templateIndex];
                    if (template) {
                        document.querySelector(`input[name="trans-art"][value="${template.Art}"]`).checked = true;
                        handleArtChange();

                        document.getElementById('trans-betrag').value = template.Betrag.toFixed(2).replace('.', ',');
                        document.getElementById('trans-beschreibung').value = template.Beschreibung;

                        if (template.Art !== 'Überweisung') {
                            document.getElementById('trans-kategorie').value = template.Kategorie;
                            document.getElementById('trans-konto').value = template.Konto;
                            if (template.Zahlungsmethode === 'Bar') {
                                document.getElementById('trans-zahlungsmethode-bar').checked = true;
                            } else {
                                document.getElementById('trans-zahlungsmethode-karte').checked = true;
                            }
                            handlePaymentMethodChange();
                        }

                        document.getElementById('trans-wiederkehrend').checked = true;
                    }
                }
            });

            function openModal(transactionId = null) {
                modalForm.reset();
                document.getElementById('trans-art-ausgabe').checked = true;
                document.getElementById('trans-zahlungsmethode-karte').checked = true;
                renderTemplates();

                if (transactionId) {
                    modalTitle.textContent = "Transaktion bearbeiten";
                    const transaction = allTransactions.find(t => t.id === transactionId);
                    if (transaction) {
                        if (transaction.Kategorie === 'Überweisung') {
                            showNotification('Überweisungen können nicht direkt bearbeitet werden. Bitte löschen und neu erstellen.', 4000);
                            return;
                        }
                        modalForm.dataset.editingId = transactionId;

                        document.querySelector(`input[name="trans-art"][value="${transaction.Art}"]`).checked = true;

                        transDatumInput.value = transaction.parsedDate;
                        transDatumDisplay.value = formatGermanDate(transaction.parsedDate);
                        transBetragInput.value = transaction.Betrag.toFixed(2).replace('.', ',');
                        document.getElementById('trans-beschreibung').value = transaction.Beschreibung;
                        updateCategoryOptions();
                        document.getElementById('trans-kategorie').value = transaction.Kategorie;
                        document.getElementById('trans-konto').value = transaction.Konto;
                        if (transaction.Zahlungsmethode === 'Bar') {
                            document.getElementById('trans-zahlungsmethode-bar').checked = true;
                        } else {
                            document.getElementById('trans-zahlungsmethode-karte').checked = true;
                        }
                        document.getElementById('trans-wiederkehrend').checked = transaction.Wiederkehrend === 'Ja';
                        document.getElementById('trans-sonstige-infos').value = transaction['Sonstige Infos'] || '';
                    }
                } else {
                    modalTitle.innerHTML = "Neue Transaktion";
                    const titleSubtext = modalTitle.nextElementSibling;
                    if (titleSubtext) {
                        titleSubtext.textContent = "Füge eine neue Buchung hinzu oder wähle eine Vorlage.";
                    }
                    delete modalForm.dataset.editingId;
                    const todayIso = new Date().toISOString().split('T')[0];
                    transDatumInput.value = todayIso;
                    transDatumDisplay.value = formatGermanDate(todayIso);
                }

                handleArtChange();
                handlePaymentMethodChange();

                modalOverlay.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                lucide.createIcons();
            }

            function closeModal() {
                modalOverlay.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
            }

            document.getElementById('add-transaction-btn').addEventListener('click', () => openModal());
            document.getElementById('fab-add-transaction').addEventListener('click', () => openModal());
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', closeModal);

            transDatumInput.addEventListener('change', () => {
                transDatumDisplay.value = formatGermanDate(transDatumInput.value);
            });

            transDatumDisplay.addEventListener('click', () => {
                try {
                    transDatumInput.showPicker();
                } catch (e) {
                    console.log("showPicker() is not supported on this browser.");
                }
            });
            openDatePickerBtn.addEventListener('click', () => {
                try {
                    transDatumInput.showPicker();
                } catch (e) {
                    console.log("showPicker() is not supported on this browser.");
                }
            });

            transBetragInput.addEventListener('input', (e) => {
                let value = e.target.value;
                value = value.replace(/[^0-9,.]/g, ''); // Allow numbers, comma, dot
                value = value.replace(/,/, '.'); // Convert comma to dot for processing
                e.target.value = value;
            });


            modalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const editingId = modalForm.dataset.editingId;
                const parsedDate = transDatumInput.value;
                const displayDate = formatGermanDate(parsedDate);
                const betrag = parseFloat(transBetragInput.value.replace(',', '.'));
                const beschreibung = document.getElementById('trans-beschreibung').value;
                const isWiederkehrend = document.getElementById('trans-wiederkehrend').checked;
                const sonstigeInfos = document.getElementById('trans-sonstige-infos').value;
                const art = document.querySelector('input[name="trans-art"]:checked').value;

                if (art === 'Überweisung') {
                    const vonKonto = transKontoVonSelect.value;
                    const zuKonto = transKontoZuSelect.value;

                    if (vonKonto === zuKonto) {
                        showNotification('Quell- und Zielkonto dürfen nicht identisch sein.', 3000);
                        return;
                    }

                    const transferId = crypto.randomUUID();

                    allTransactions.push({
                        id: crypto.randomUUID(),
                        transferId: transferId,
                        Datum: displayDate,
                        Art: 'Ausgabe',
                        Betrag: betrag,
                        Beschreibung: `Überweisung an ${zuKonto}`,
                        Kategorie: 'Überweisung',
                        Konto: vonKonto,
                        Zahlungsmethode: 'Überweisung',
                        Wiederkehrend: isWiederkehrend ? 'Ja' : 'Nein',
                        parsedDate: parsedDate,
                        ['Sonstige Infos']: sonstigeInfos
                    });

                    allTransactions.push({
                        id: crypto.randomUUID(),
                        transferId: transferId,
                        Datum: displayDate,
                        Art: 'Einnahme',
                        Betrag: betrag,
                        Beschreibung: `Überweisung von ${vonKonto}`,
                        Kategorie: 'Überweisung',
                        Konto: zuKonto,
                        Zahlungsmethode: 'Überweisung',
                        Wiederkehrend: isWiederkehrend ? 'Ja' : 'Nein',
                        parsedDate: parsedDate,
                        ['Sonstige Infos']: sonstigeInfos
                    });

                } else {
                    const transactionData = {
                        Datum: displayDate,
                        Art: art,
                        Betrag: betrag,
                        Beschreibung: beschreibung,
                        Kategorie: document.getElementById('trans-kategorie').value,
                        Konto: document.getElementById('trans-zahlungsmethode-bar').checked ? 'Bargeld' : transKontoSelect.value,
                        Zahlungsmethode: document.querySelector('input[name="trans-zahlungsmethode"]:checked').value,
                        Wiederkehrend: isWiederkehrend ? 'Ja' : 'Nein',
                        parsedDate: parsedDate,
                        ['Sonstige Infos']: sonstigeInfos
                    };

                    if (editingId) {
                        const index = allTransactions.findIndex(t => t.id === editingId);
                        if (index !== -1) {
                            allTransactions[index] = { ...allTransactions[index],
                                ...transactionData
                            };
                        }
                    } else {
                        allTransactions.push({ ...transactionData,
                            id: crypto.randomUUID()
                        });
                    }
                }

                if (isWiederkehrend) {
                    const templateData = {
                        Beschreibung: beschreibung,
                        Betrag: betrag,
                        Art: art,
                        Kategorie: art === 'Überweisung' ? 'Überweisung' : document.getElementById('trans-kategorie').value,
                        Konto: art === 'Überweisung' ? '' : (document.getElementById('trans-zahlungsmethode-bar').checked ? 'Bargeld' : transKontoSelect.value),
                        Zahlungsmethode: art === 'Überweisung' ? 'Überweisung' : document.querySelector('input[name="trans-zahlungsmethode"]:checked').value,
                    };
                    const templateExists = recurringTemplates.some(t => JSON.stringify(t) === JSON.stringify(templateData));
                    if (!templateExists) {
                        recurringTemplates.push(templateData);
                        saveTemplates();
                    }
                }

                transactionDates = new Set(allTransactions.map(t => t.parsedDate));
                saveTransactions();
                currentPage = 1;
                updateDashboard();
                renderCalendar();
                closeModal();
            });


            // --- KALENDER SEITENLEISTE LOGIK ---
            const calendarSidebar = document.getElementById('calendar-sidebar');
            const calendarSidebarOverlay = document.getElementById('calendar-sidebar-overlay');
            const openCalendarBtn = document.getElementById('fab-open-calendar');
            const closeCalendarBtn = document.getElementById('close-calendar-sidebar-btn');

            function openCalendarSidebar() {
                calendarSidebarOverlay.classList.remove('opacity-0', 'pointer-events-none');
                calendarSidebar.classList.remove('translate-x-full');
                lucide.createIcons();
            }

            function closeCalendarSidebar() {
                calendarSidebarOverlay.classList.add('opacity-0', 'pointer-events-none');
                calendarSidebar.classList.add('translate-x-full');
            }

            openCalendarBtn.addEventListener('click', openCalendarSidebar);
            closeCalendarBtn.addEventListener('click', closeCalendarSidebar);
            calendarSidebarOverlay.addEventListener('click', closeCalendarSidebar);


           // --- DASHBOARD MODAL LOGIC ---
           const dashboardWrapper = document.getElementById('dashboard-content-wrapper');
           const openDashboardBtn = document.getElementById('fab-open-dashboard');
           const closeDashboardBtn = document.getElementById('close-dashboard-btn');

           function openDashboardModal() {
               if (dashboardWrapper) {
                   dashboardWrapper.classList.add('is-open');
                   // Re-render charts because their container was hidden
                   const accountFilteredData = (currentFilter === 'all') ? allTransactions : allTransactions.filter(row => row.Konto === currentFilter);
                   const financialSummary = processData(accountFilteredData);
                   createOrUpdateCharts(financialSummary);
                   lucide.createIcons();
               }
           }

           function closeDashboardModal() {
               if (dashboardWrapper) {
                   dashboardWrapper.classList.remove('is-open');
               }
           }

           openDashboardBtn.addEventListener('click', openDashboardModal);
           closeDashboardBtn.addEventListener('click', closeDashboardModal);


            // --- THEME SYNCHRONISATION ---
            const themeObserver = new MutationObserver((mutations) => {
                mutations.forEach(mutation => {
                    if (mutation.attributeName === 'data-theme') {
                        const accountFilteredData = (currentFilter === 'all') ? allTransactions : allTransactions.filter(row => row.Konto === currentFilter);
                        const financialSummary = processData(accountFilteredData);
                        createOrUpdateCharts(financialSummary);
                        lucide.createIcons();
                    }
                });
            });
            themeObserver.observe(document.documentElement, {
                attributes: true
            });

            window.addEventListener('message', (event) => {
                if (typeof event.data === 'string' && event.data.startsWith('set-theme-')) {
                    const theme = event.data.split('-')[2];
                    if (theme === 'light' || theme === 'dark') {
                        document.documentElement.dataset.theme = theme;
                    }
                }
            });

            // --- INITIALIZATION ---
            loadData();
            updateDashboard();
            renderCalendar();
            lucide.createIcons();
        });
    </script>
</body>

<script>
    window.addEventListener('message', (event) => {
        if (event.source !== window.parent) {
            return;
        }
        const message = event.data;
        if (message && message.type === 'backupDataRequest') {
            const transactionsData = localStorage.getItem('aurimea-transactions');
            window.parent.postMessage({
                type: 'backupDataResponse',
                key: 'aurimea',
                data: JSON.parse(transactionsData || '[]')
            }, '*');
        }
        if (message && message.type === 'restoreBackupData') {
            const restoredTransactions = message.data;
            if (Array.isArray(restoredTransactions)) {
                localStorage.setItem('aurimea-transactions', JSON.stringify(restoredTransactions));
                window.location.reload();
            }
        }
    });
</script>

</html>