<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HabitMea - Verfolge deine Gewohnheiten</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f1f5f9;
            /* slate-100 */
            --text-color: #1e293b;
            /* slate-800 */
            --text-color-light: #64748b;
            /* slate-500 */
            --header-color: #0f172a;
            /* slate-900 */
            --card-bg: #ffffff;
            --card-border-color: #e2e8f0;
            /* slate-200 */
            --item-bg: #f8fafc;
            /* slate-50 */
            --item-bg-hover: #f1f5f9;
            /* slate-100 */
            --input-bg: #f8fafc;
            /* slate-50 */
            --input-border-color: #cbd5e1;
            /* slate-300 */
            --modal-bg: #ffffff;
            --modal-border-color: #e2e8f0;
            /* slate-200 */
            --scrollbar-track: #f1f5f9;
            --scrollbar-thumb: #cbd5e1;
            --scrollbar-thumb-hover: #94a3b8;
            --progress-bg: #e2e8f0;
            /* slate-200 */
            --today-bg: #e0e7ff;
            /* indigo-100 */
            --day-bg-red: rgba(239, 68, 68, 0.2);
            --day-bg-yellow: rgba(234, 179, 8, 0.2);
            --day-bg-green: rgba(34, 197, 94, 0.2);
        }

        html[data-theme='dark'] {
            --bg-color: #171717;
            /* neutral-900 */
            --text-color: #f5f5f5;
            /* neutral-200 */
            --text-color-light: #a3a3a3;
            /* neutral-400 */
            --header-color: #ffffff;
            --card-bg: rgba(38, 38, 38, 0.5);
            /* neutral-800/50 */
            --card-border-color: #404040;
            /* neutral-700 */
            --item-bg: #262626;
            /* neutral-900 */
            --item-bg-hover: #404040;
            /* neutral-700 */
            --input-bg: #262626;
            /* neutral-900 */
            --input-border-color: #525252;
            /* neutral-600 */
            --modal-bg: #262626;
            /* neutral-800 */
            --modal-border-color: #404040;
            /* neutral-700 */
            --scrollbar-track: #171717;
            --scrollbar-thumb: #404040;
            --scrollbar-thumb-hover: #525252;
            --progress-bg: #404040;
            /* neutral-700 */
            --today-bg: rgba(67, 56, 202, 0.5);
            /* indigo-800/50 */
            --day-bg-red: rgba(239, 68, 68, 0.3);
            --day-bg-yellow: rgba(234, 179, 8, 0.3);
            --day-bg-green: rgba(34, 197, 94, 0.3);
        }

        body {
            font-family: 'Ubuntu', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        .modal {
            display: none;
        }

        .modal.flex {
            display: flex;
        }

        .calendar-day {
            transition: background-color 0.2s ease-in-out;
        }

        .cursor-grabbing {
            cursor: grabbing;
        }

        .noselect {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>

<body class="antialiased min-h-screen flex flex-col" style="background-color: var(--bg-color);">

    <div class="flex flex-col flex-grow">

        <header class="text-center pt-8 pb-4 flex-shrink-0 px-4 sm:px-6 lg:px-8">
            <h1 class="text-4xl sm:text-5xl font-bold mb-2" style="color: var(--header-color);">HabitMea</h1>
            <p class="text-md sm:text-lg" style="color: var(--text-color-light);">Ein Ort für deine Gewohnheiten, Medien und mehr.</p>
        </header>

        <div class="pb-8 flex-shrink-0 flex flex-wrap justify-center items-center gap-2 sm:gap-4 px-4 sm:px-6 lg:px-8">
            <button id="open-add-list-modal-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold p-3 sm:px-6 rounded-lg transition-all duration-300 inline-flex items-center shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                <i class="material-icons sm:mr-2">playlist_add</i>
                <span class="hidden sm:inline">Neue Liste</span>
            </button>
            <button id="table-of-contents-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-bold p-3 sm:px-6 rounded-lg transition-colors duration-300 inline-flex items-center shadow-md">
                <i class="material-icons sm:mr-2">list</i>
                <span class="hidden sm:inline">Übersicht</span>
            </button>
            <button id="export-btn" class="bg-sky-600 hover:bg-sky-500 text-white font-bold p-3 sm:px-4 rounded-lg transition-colors duration-300 inline-flex items-center shadow-md">
                <i class="material-icons sm:mr-2">file_download</i>
                <span class="hidden sm:inline">Export</span>
            </button>
            <button id="import-btn" class="bg-violet-600 hover:bg-violet-500 text-white font-bold p-3 sm:px-4 rounded-lg transition-colors duration-300 inline-flex items-center shadow-md">
                <i class="material-icons sm:mr-2">file_upload</i>
                <span class="hidden sm:inline">Import</span>
            </button>
            <button id="delete-all-data-btn" class="bg-rose-600 hover:bg-rose-500 text-white font-bold p-3 sm:px-4 rounded-lg transition-colors duration-300 inline-flex items-center shadow-md">
                <i class="material-icons sm:mr-2">delete_sweep</i>
                <span class="hidden sm:inline">Reset</span>
            </button>
            <input type="file" id="import-file-input" class="hidden" accept=".json">
        </div>

        <main class="flex-grow w-full px-4 sm:px-6 lg:px-8">
            <div id="main-grid" class="grid grid-cols-1 lg:grid-cols-3 xl:grid-cols-4 gap-8 max-w-screen-2xl mx-auto">

            <section id="habits"
                class="lg:col-span-2 xl:col-span-2 rounded-2xl p-4 sm:p-6 shadow-lg flex flex-col transition-all duration-300 hover:shadow-xl"
                style="background-color: var(--card-bg); border: 1px solid var(--card-border-color);"
                data-list-type="habit">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center">
                        <i class="material-icons text-3xl text-emerald-500 mr-4"
                            style="color: var(--text-color-light);">task_alt</i>
                        <h2 class="text-2xl font-bold" style="color: var(--header-color);">Tägliche Gewohnheiten</h2>
                    </div>
                    <div class="flex items-center gap-1">
                        <button id="open-manage-habits-modal-btn" class="p-2 rounded-full" title="Gewohnheiten verwalten"
                            style="color: var(--text-color-light); background-color: var(--item-bg-hover);">
                            <i class="material-icons text-base">add</i>
                        </button>
                        <button class="open-completed-btn p-2 rounded-full" title="Erledigte anzeigen"
                            style="color: var(--text-color-light); background-color: var(--item-bg-hover);">
                            <i class="material-icons text-base">done_all</i>
                        </button>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row flex-grow gap-6 min-h-0">
                    <div class="w-full md:w-3/5 flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-full"
                                style="background-color: var(--item-bg-hover);"><i
                                    class="material-icons">chevron_left</i></button>
                            <h3 id="month-year-header" class="text-lg font-semibold"
                                style="color: var(--header-color);"></h3>
                            <button id="next-month-btn" class="p-2 rounded-full"
                                style="background-color: var(--item-bg-hover);"><i
                                    class="material-icons">chevron_right</i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center text-xs font-medium mb-2"
                            style="color: var(--text-color-light);">
                            <div>Mo</div>
                            <div>Di</div>
                            <div>Mi</div>
                            <div>Do</div>
                            <div>Fr</div>
                            <div>Sa</div>
                            <div>So</div>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                        </div>
                    </div>
                    <div class="w-full md:w-2/5 border-t md:border-t-0 md:border-l pt-6 md:pt-0 md:pl-6 flex flex-col"
                        style="border-color: var(--card-border-color);">
                        <h3 class="text-lg font-semibold mb-3 flex-shrink-0" style="color: var(--header-color);">Heutige
                            Gewohnheiten</h3>
                        <div id="todays-habits-list" class="space-y-3 flex-grow overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </section>

            <section id="books"
                class="rounded-2xl p-6 shadow-lg flex flex-col transition-all duration-300 hover:shadow-xl"
                style="background-color: var(--card-bg); border: 1px solid var(--card-border-color);"
                data-list-type="book">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center mr-2">
                        <i class="material-icons text-3xl text-sky-500 mr-4"
                            style="color: var(--text-color-light);">menu_book</i>
                        <h2 class="text-2xl font-bold" style="color: var(--header-color);">Meine Bücher</h2>
                    </div>
                    <div class="flex items-center gap-1">
                        <button class="add-item-btn p-2 rounded-full" title="Neues Buch"
                            style="color: var(--text-color-light); background-color: var(--item-bg-hover);">
                            <i class="material-icons text-base">add</i>
                        </button>
                        <button class="open-completed-btn p-2 rounded-full" title="Erledigte anzeigen"
                            style="color: var(--text-color-light); background-color: var(--item-bg-hover);">
                            <i class="material-icons text-base">done_all</i>
                        </button>
                    </div>
                </div>
                <div class="space-y-3 list-none p-0 overflow-y-auto pr-2 item-container" style="max-height: 35rem;">
                </div>
            </section>
            <section id="media"
                class="rounded-2xl p-6 shadow-lg flex flex-col transition-all duration-300 hover:shadow-xl"
                style="background-color: var(--card-bg); border: 1px solid var(--card-border-color);"
                data-list-type="media">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center mr-2">
                        <i class="material-icons text-3xl text-rose-500 mr-4"
                            style="color: var(--text-color-light);">theaters</i>
                        <h2 class="text-2xl font-bold" style="color: var(--header-color);">Filme & Serien</h2>
                    </div>
                    <div class="flex items-center gap-1">
                        <button class="add-item-btn p-2 rounded-full" title="Neuer Eintrag"
                            style="color: var(--text-color-light); background-color: var(--item-bg-hover);">
                            <i class="material-icons text-base">add</i>
                        </button>
                        <button class="open-completed-btn p-2 rounded-full" title="Erledigte anzeigen"
                            style="color: var(--text-color-light); background-color: var(--item-bg-hover);">
                            <i class="material-icons text-base">done_all</i>
                        </button>
                    </div>
                </div>
                <div class="space-y-3 list-none p-0 overflow-y-auto pr-2 item-container" style="max-height: 35rem;">
                </div>
            </section>
            </div>
        </main>
    </div>

    <div id="completed-items-modal"
        class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="rounded-2xl shadow-2xl w-full max-w-lg border"
            style="background-color: var(--modal-bg); border-color: var(--modal-border-color);">
            <div class="flex justify-between items-center p-4 border-b"
                style="border-color: var(--modal-border-color);">
                <h3 id="completed-items-modal-title" class="text-xl font-bold" style="color: var(--header-color);">
                    Erledigte Einträge</h3><button class="modal-close-btn" style="color: var(--text-color-light);"><i
                        class="material-icons">close</i></button>
            </div>
            <div id="completed-items-list" class="p-6 max-h-96 overflow-y-auto space-y-3"></div>
        </div>
    </div>
    <div id="day-habits-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="rounded-2xl shadow-2xl w-full max-w-md border"
            style="background-color: var(--modal-bg); border-color: var(--modal-border-color);">
            <div class="flex justify-between items-center p-4 border-b"
                style="border-color: var(--modal-border-color);">
                <h3 id="day-habits-modal-title" class="text-xl font-bold" style="color: var(--header-color);">
                    Gewohnheiten für</h3><button class="modal-close-btn" style="color: var(--text-color-light);"><i
                        class="material-icons">close</i></button>
            </div>
            <div id="day-habits-list" class="p-6 max-h-96 overflow-y-auto space-y-4"></div>
        </div>
    </div>
    <div id="manage-habits-modal"
        class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="rounded-2xl shadow-2xl w-full max-w-md border"
            style="background-color: var(--modal-bg); border-color: var(--modal-border-color);">
            <div class="flex justify-between items-center p-4 border-b"
                style="border-color: var(--modal-border-color);">
                <h3 class="text-xl font-bold" style="color: var(--header-color);">Gewohnheiten verwalten</h3><button
                    class="modal-close-btn" style="color: var(--text-color-light);"><i
                        class="material-icons">close</i></button>
            </div>
            <div id="manage-habits-list" class="p-6 max-h-80 overflow-y-auto space-y-3"></div>
            <div class="p-6 border-t" style="border-color: var(--modal-border-color);"><label for="new-habit-def-title"
                    class="block mb-2 text-sm font-medium" style="color: var(--text-color-light);">Neue Gewohnheit
                    hinzufügen</label>
                <div class="flex gap-2"><input type="text" id="new-habit-def-title" class="w-full rounded-lg p-2.5"
                        style="background-color: var(--input-bg); border: 1px solid var(--input-border-color);"
                        placeholder="z.B. Meditieren"><button id="add-habit-def-save-btn"
                        class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-4 rounded-lg"><i
                            class="material-icons">add</i></button></div>
            </div>
        </div>
    </div>
    <div id="details-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="rounded-2xl shadow-2xl w-full max-w-md border"
            style="background-color: var(--modal-bg); border-color: var(--modal-border-color);">
            <div class="flex justify-between items-center p-4 border-b"
                style="border-color: var(--modal-border-color);">
                <h3 id="modal-title" class="text-xl font-bold" style="color: var(--header-color);">Details</h3><button
                    class="modal-close-btn" style="color: var(--text-color-light);"><i
                        class="material-icons">close</i></button>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-3" style="color: var(--header-color);">Status</h4>
                    <div id="modal-status-options" class="flex flex-wrap gap-3"></div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-3" style="color: var(--header-color);">Meine Notizen</h4>
                    <textarea id="modal-notes" rows="4" class="w-full rounded-lg p-3"
                        style="background-color: var(--input-bg); border: 1px solid var(--input-border-color);"></textarea>
                </div>
            </div>
            <div class="flex justify-between p-4 border-t"
                style="background-color: var(--card-bg); border-color: var(--modal-border-color);"><button
                    id="delete-item-btn"
                    class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-lg"><i
                        class="material-icons text-base mr-1">delete</i>Löschen</button><button id="modal-save-btn"
                    class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-5 rounded-lg">Speichern</button>
            </div>
        </div>
    </div>
    <div id="add-list-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="rounded-2xl shadow-2xl w-full max-w-md border"
            style="background-color: var(--modal-bg); border-color: var(--modal-border-color);">
            <div class="flex justify-between items-center p-4 border-b"
                style="border-color: var(--modal-border-color);">
                <h3 class="text-xl font-bold" style="color: var(--header-color);">Neue Liste erstellen</h3><button
                    class="modal-close-btn" style="color: var(--text-color-light);"><i
                        class="material-icons">close</i></button>
            </div>
            <div class="p-6 space-y-4">
                <div><label for="new-list-title" class="block mb-2 text-sm font-medium"
                        style="color: var(--text-color-light);">Titel der Liste</label><input type="text"
                        id="new-list-title" class="w-full rounded-lg p-2.5"
                        style="background-color: var(--input-bg); border: 1px solid var(--input-border-color);"
                        placeholder="z.B. Meine Videospiele"></div>
            </div>
            <div class="flex justify-end p-4 border-t"
                style="background-color: var(--card-bg); border-color: var(--modal-border-color);"><button
                    id="add-list-save-btn"
                    class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-5 rounded-lg">Erstellen</button>
            </div>
        </div>
    </div>
    <div id="add-item-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="rounded-2xl shadow-2xl w-full max-w-md border"
            style="background-color: var(--modal-bg); border-color: var(--modal-border-color);">
            <div class="flex justify-between items-center p-4 border-b"
                style="border-color: var(--modal-border-color);">
                <h3 id="add-item-modal-title" class="text-xl font-bold" style="color: var(--header-color);">Neuen
                    Eintrag</h3><button class="modal-close-btn" style="color: var(--text-color-light);"><i
                        class="material-icons">close</i></button>
            </div>
            <form id="add-item-form" class="p-6 space-y-4"></form>
            <div class="flex justify-end p-4 border-t"
                style="background-color: var(--card-bg); border-color: var(--modal-border-color);"><button
                    id="add-item-save-btn"
                    class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-5 rounded-lg">Hinzufügen</button>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="rounded-2xl shadow-2xl w-full max-w-sm border"
            style="background-color: var(--modal-bg); border-color: var(--modal-border-color);">
            <div class="p-6 text-center"><i class="material-icons text-5xl text-amber-500 mb-4">warning_amber</i>
                <h3 id="confirm-modal-text" class="text-lg mb-6" style="color: var(--text-color);">Möchtest du das
                    wirklich löschen?</h3>
                <div class="flex justify-center gap-4"><button id="confirm-cancel-btn"
                        class="font-bold py-2 px-6 rounded-lg"
                        style="background-color: var(--item-bg-hover); color: var(--text-color);">Abbrechen</button><button
                        id="confirm-delete-btn"
                        class="bg-rose-600 hover:bg-rose-500 text-white font-bold py-2 px-6 rounded-lg">Löschen</button>
                </div>
            </div>
        </div>
    </div>
    <div id="table-of-contents-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="rounded-2xl shadow-2xl w-full max-w-md border"
            style="background-color: var(--modal-bg); border-color: var(--modal-border-color);">
            <div class="flex justify-between items-center p-4 border-b"
                style="border-color: var(--modal-border-color);">
                <h3 class="text-xl font-bold" style="color: var(--header-color);">Inhaltsverzeichnis</h3>
                <button class="modal-close-btn" style="color: var(--text-color-light);">
                    <i class="material-icons">close</i>
                </button>
            </div>
            <div id="table-of-contents-list" class="p-6 max-h-96 overflow-y-auto space-y-3"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            let allHabits = [];
            let dailyLog = {};
            let currentDate = new Date();

            // --- GLOBAL ELEMENTS ---
            const mainGrid = document.getElementById('main-grid');
            const allModals = document.querySelectorAll('.modal');

            // --- TABLE OF CONTENTS ELEMENTS ---
            const tableOfContentsBtn = document.getElementById('table-of-contents-btn');
            const tableOfContentsModal = document.getElementById('table-of-contents-modal');
            const tableOfContentsList = document.getElementById('table-of-contents-list');

            // --- CALENDAR ELEMENTS ---
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearHeader = document.getElementById('month-year-header');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const todaysHabitsList = document.getElementById('todays-habits-list');

            // --- MODAL ELEMENTS ---
            const dayHabitsModal = document.getElementById('day-habits-modal');
            const dayHabitsModalTitle = document.getElementById('day-habits-modal-title');
            const dayHabitsList = document.getElementById('day-habits-list');
            const manageHabitsModal = document.getElementById('manage-habits-modal');
            const openManageHabitsModalBtn = document.getElementById('open-manage-habits-modal-btn');
            const manageHabitsList = document.getElementById('manage-habits-list');
            const addHabitDefSaveBtn = document.getElementById('add-habit-def-save-btn');
            const newHabitDefTitleInput = document.getElementById('new-habit-def-title');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmModalText = document.getElementById('confirm-modal-text');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            const completedItemsModal = document.getElementById('completed-items-modal');
            const completedItemsList = document.getElementById('completed-items-list');
            const completedItemsModalTitle = document.getElementById('completed-items-modal-title');

            // --- IMPORT/EXPORT ELEMENTS ---
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const importFileInput = document.getElementById('import-file-input');

            // --- DATA PERSISTENCE ---
            const saveData = () => {
                try {
                    const dataToSave = gatherDataForExport();
                    localStorage.setItem('habitmea_data', JSON.stringify(dataToSave));
                } catch (e) {
                    console.error("Error saving data to localStorage", e);
                }
            };

            const loadData = () => {
                try {
                    const savedData = localStorage.getItem('habitmea_data');
                    if (savedData) {
                        const parsedData = JSON.parse(savedData);
                        renderImportedData(parsedData, false); // false to avoid confirm modal
                    }
                } catch (e) {
                    console.error("Error loading data from localStorage", e);
                    allHabits = [];
                    dailyLog = {};
                }
            };

            // --- HELPER ---
            const getDateString = (date) => `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;

            // --- MODAL & ACTION LOGIC ---
            const closeModal = (modal) => modal.classList.remove('flex');
            const openModal = (modal) => modal.classList.add('flex');

            allModals.forEach(modal => {
                modal.addEventListener('click', (event) => { if (event.target === modal) closeModal(modal); });
                modal.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', () => closeModal(modal)));
            });

            let onConfirmCallback = null;
            const openConfirmModal = (text, callback) => {
                confirmModalText.textContent = text;
                onConfirmCallback = callback;
                openModal(confirmModal);
            };
            confirmDeleteBtn.addEventListener('click', () => {
                if (onConfirmCallback) onConfirmCallback();
                closeModal(confirmModal);
            });
            confirmCancelBtn.addEventListener('click', () => closeModal(confirmModal));

            // --- HABIT & CALENDAR LOGIC ---
            const updateHabitLog = (dateStr, habit, isChecked) => {
                if (!dailyLog[dateStr]) dailyLog[dateStr] = {};
                dailyLog[dateStr][habit] = isChecked;
                saveData();
                renderAllHabits();
            };

            const renderTodaysHabits = () => {
                todaysHabitsList.innerHTML = '';
                const todayStr = getDateString(new Date());
                const todayLog = dailyLog[todayStr] || {};
                if (allHabits.length === 0) { todaysHabitsList.innerHTML = `<p class="text-sm" style="color: var(--text-color-light);">Definiere eine Gewohnheit.</p>`; }
                else {
                    allHabits.forEach(habit => {
                        const isChecked = todayLog[habit] || false;
                        todaysHabitsList.insertAdjacentHTML('beforeend', `<div class="flex items-center p-3 rounded-lg" style="background-color: var(--item-bg);"><input type="checkbox" id="today-habit-${habit.replace(/\s/g, '')}" class="habit-checkbox form-checkbox h-5 w-5" style="background-color: var(--input-bg); border-color: var(--input-border-color);" data-habit="${habit}" data-date="${todayStr}" ${isChecked ? 'checked' : ''}><label for="today-habit-${habit.replace(/\s/g, '')}" class="ml-3 text-base flex-grow cursor-pointer">${habit}</label></div>`);
                    });
                }
            };

            const renderCalendar = () => {
                calendarGrid.innerHTML = '';
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                monthYearHeader.textContent = currentDate.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const offset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                for (let i = 0; i < offset; i++) calendarGrid.insertAdjacentHTML('beforeend', '<div></div>');
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dateStr = getDateString(date);
                    const log = dailyLog[dateStr] || {};
                    const totalHabits = allHabits.length;
                    const completedHabits = totalHabits > 0 ? Object.values(log).filter(Boolean).length : 0;
                    const progress = totalHabits > 0 ? (completedHabits / totalHabits) * 100 : 0;
                    
                    const cellDate = new Date(date);
                    cellDate.setHours(0, 0, 0, 0);
                    const isToday = cellDate.getTime() === today.getTime();
                    
                    let dayBgColor = 'var(--item-bg)'; // Default for future days

                    if (totalHabits > 0) {
                        if (progress === 100) {
                            dayBgColor = 'var(--day-bg-green)'; // All done
                        } else if (progress > 0) {
                            dayBgColor = 'var(--day-bg-yellow)'; // Some done
                        } else if (cellDate < today) { // Past day with nothing done
                            dayBgColor = 'var(--day-bg-red)';
                        }
                    }

                    const todayClass = isToday ? 'border-2 border-indigo-500' : 'border border-transparent';

                    const dayCellHTML = `
                    <div class="calendar-day rounded-lg flex flex-col justify-center items-center p-1 aspect-square cursor-pointer ${todayClass}" style="background-color: ${dayBgColor};" data-date="${dateStr}">
                        <span class="font-semibold text-lg" style="color: var(--header-color);">${day}</span>
                    </div>`;
                    calendarGrid.insertAdjacentHTML('beforeend', dayCellHTML);
                }
            };

            const renderAllHabits = () => { renderCalendar(); renderTodaysHabits(); };
            prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
            nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
            document.getElementById('habits').addEventListener('change', (e) => { if (e.target.classList.contains('habit-checkbox')) updateHabitLog(e.target.dataset.date, e.target.dataset.habit, e.target.checked); });
            calendarGrid.addEventListener('click', (e) => {
                const dayCell = e.target.closest('.calendar-day');
                if (!dayCell) return;
                const dateStr = dayCell.dataset.date;
                const [year, month, day] = dateStr.split('-');
                dayHabitsModalTitle.textContent = `Gewohnheiten für den ${new Date(year, month - 1, day).toLocaleDateString('de-DE', { dateStyle: 'long' })}`;
                dayHabitsList.innerHTML = '';
                const dayLog = dailyLog[dateStr] || {};
                if (allHabits.length === 0) { dayHabitsList.innerHTML = `<p style="color: var(--text-color-light);">Keine Gewohnheiten definiert.</p>`; }
                else { allHabits.forEach(habit => dayHabitsList.insertAdjacentHTML('beforeend', `<div class="flex items-center p-4 rounded-lg" style="background-color: var(--item-bg);"><input type="checkbox" id="modal-habit-${habit.replace(/\s/g, '')}-${day}" class="habit-checkbox form-checkbox h-5 w-5" style="background-color: var(--input-bg); border-color: var(--input-border-color);" data-habit="${habit}" data-date="${dateStr}" ${dayLog[habit] || false ? 'checked' : ''}><label for="modal-habit-${habit.replace(/\s/g, '')}-${day}" class="ml-4 text-lg flex-grow cursor-pointer">${habit}</label></div>`)); }
                openModal(dayHabitsModal);
            });

            const renderManageHabitsList = () => {
                manageHabitsList.innerHTML = '';
                allHabits.forEach(habit => manageHabitsList.insertAdjacentHTML('beforeend', `<div class="flex justify-between items-center p-3 rounded-lg" style="background-color: var(--item-bg);"><span>${habit}</span><button class="delete-habit-btn" style="color: var(--text-color-light);" data-habit="${habit}"><i class="material-icons">delete</i></button></div>`));
            };
            openManageHabitsModalBtn.addEventListener('click', () => { renderManageHabitsList(); openModal(manageHabitsModal); });
            addHabitDefSaveBtn.addEventListener('click', () => {
                const newHabit = newHabitDefTitleInput.value.trim();
                if (newHabit && !allHabits.includes(newHabit)) {
                    allHabits.push(newHabit);
                    renderManageHabitsList();
                    renderAllHabits();
                    saveData();
                }
                newHabitDefTitleInput.value = '';
            });
            newHabitDefTitleInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') addHabitDefSaveBtn.click(); });
            manageHabitsList.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-habit-btn');
                if (!deleteBtn) return;
                const habitToDelete = deleteBtn.dataset.habit;
                openConfirmModal(`Soll die Gewohnheit "${habitToDelete}" wirklich gelöscht werden? Alle Einträge dazu gehen verloren.`, () => {
                    allHabits = allHabits.filter(h => h !== habitToDelete);
                    for (const date in dailyLog) { delete dailyLog[date][habitToDelete]; }
                    renderManageHabitsList();
                    renderAllHabits();
                    saveData();
                });
            });

            document.getElementById('delete-all-data-btn').addEventListener('click', () => {
                openConfirmModal('Sollen wirklich ALLE Daten (Gewohnheiten, Listen, Einträge) gelöscht werden? Diese Aktion kann nicht rückgängig gemacht werden.', () => {
                    allHabits = [];
                    dailyLog = {};
                    document.querySelectorAll('#main-grid > section:not(#habits)').forEach(section => {
                        if (section.id === 'books' || section.id === 'media') {
                            section.querySelector('.item-container').innerHTML = '';
                        } else {
                            section.remove();
                        }
                    });
                    renderAllHabits();
                    saveData();
                });
            });

            // --- GENERAL LIST & ITEM LOGIC ---
            const detailsModal = document.getElementById('details-modal');
            const addListModal = document.getElementById('add-list-modal');
            const addItemModal = document.getElementById('add-item-modal');
            const detailsModalTitle = document.getElementById('modal-title');
            const detailsModalStatusOptions = document.getElementById('modal-status-options');
            const detailsModalNotes = document.getElementById('modal-notes');
            const detailsModalSaveBtn = document.getElementById('modal-save-btn');
            const deleteItemBtn = document.getElementById('delete-item-btn');
            let currentItemElement = null;
            const openAddListModalBtn = document.getElementById('open-add-list-modal-btn');
            const addListSaveBtn = document.getElementById('add-list-save-btn');
            const newListTitleInput = document.getElementById('new-list-title');
            const addItemModalTitle = document.getElementById('add-item-modal-title');
            const addItemForm = document.getElementById('add-item-form');
            const addItemSaveBtn = document.getElementById('add-item-save-btn');
            let currentListContainer = null;
            const statusMap = {
                book: { "Gelesen": "bg-green-500 text-white", "Lese ich": "bg-yellow-500 text-white", "Warteliste": "bg-slate-500 text-white" },
                media: { "Gesehen": "bg-green-500 text-white", "Schaue ich": "bg-yellow-500 text-white", "Warteliste": "bg-slate-500 text-white" },
                default: { "Erledigt": "bg-green-500 text-white", "In Arbeit": "bg-yellow-500 text-white", "Geplant": "bg-slate-500 text-white" }
            };
            const completedStati = ["Gelesen", "Gesehen", "Erledigt"];

            mainGrid.addEventListener('click', (e) => {
                const listItem = e.target.closest('.list-item');
                const addItemBtn = e.target.closest('.add-item-btn');
                const deleteListBtn = e.target.closest('.delete-list-btn');
                const editListBtn = e.target.closest('.edit-list-btn');
                const openCompletedBtn = e.target.closest('.open-completed-btn');

                if (listItem) { handleOpenDetailsModal(listItem); }
                else if (addItemBtn) { handleOpenAddItemModal(addItemBtn); }
                else if (openCompletedBtn) { handleOpenCompletedModal(openCompletedBtn); }
                else if (deleteListBtn) {
                    const listSection = deleteListBtn.closest('section');
                    openConfirmModal(`Soll die Liste "${listSection.querySelector('h2').textContent}" wirklich gelöscht werden?`, () => {
                        listSection.remove();
                        saveData();
                    });
                }
                else if (editListBtn) {
                    handleEditListTitle(editListBtn);
                }
            });

            const handleOpenDetailsModal = (itemElement) => {
                currentItemElement = itemElement;
                const data = itemElement.dataset;
                detailsModalTitle.textContent = data.title;
                const statusType = data.type || 'default';
                const availableStatuses = statusMap[statusType] || statusMap.default;

                detailsModalStatusOptions.innerHTML = '';

                Object.keys(availableStatuses).forEach(status => {
                    // Extract color name and shade from the existing statusMap
                    const colorClass = availableStatuses[status].split(' ')[0]; // e.g., "bg-green-500"
                    const [_, colorName, baseShade] = colorClass.split('-'); // e.g., ["bg", "green", "500"]
                    const darkShade = parseInt(baseShade) + 100;

                    // Define Tailwind classes for different states
                    const baseClasses = `inline-flex items-center justify-center w-full px-3 py-1 rounded-full cursor-pointer border-2 transition-colors duration-200`;
                    const unselectedClasses = `border-${colorName}-${baseShade} text-${colorName}-${baseShade}`;
                    const hoverClasses = `hover:bg-${colorName}-${baseShade} hover:text-white`;
                    const checkedClasses = `peer-checked:bg-${colorName}-${darkShade} peer-checked:border-${colorName}-${darkShade} peer-checked:text-white`;

                    const finalClasses = `${baseClasses} ${unselectedClasses} ${hoverClasses} ${checkedClasses}`;

                    const buttonHTML = `
                    <div>
                        <input type="radio" id="status-${status.replace(/\s/g, '-')}" name="status" value="${status}" class="hidden peer" ${data.status === status ? 'checked' : ''}>
                        <label for="status-${status.replace(/\s/g, '-')}" class="${finalClasses}">
                            <div class="w-full text-sm font-semibold text-center">${status}</div>
                        </label>
                    </div>`;

                    detailsModalStatusOptions.insertAdjacentHTML('beforeend', buttonHTML);
                });

                detailsModalNotes.value = data.note || '';
                openModal(detailsModal);
            };

            const handleEditListTitle = (editBtn) => {
                const headerDiv = editBtn.closest('.flex.justify-between');
                const h2 = headerDiv.querySelector('h2');
                if (!h2) return;

                const currentTitle = h2.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentTitle;
                input.className = 'text-2xl font-bold w-full bg-transparent focus:outline-none border-b-2';
                input.style.borderColor = 'var(--input-border-color)';
                input.style.color = 'var(--header-color)';

                h2.replaceWith(input);
                input.focus();
                input.select();

                const finishEditing = (save) => {
                    const newTitle = input.value.trim();
                    if (save && newTitle) {
                        h2.textContent = newTitle;
                    } else {
                        h2.textContent = currentTitle;
                    }
                    if (document.body.contains(input)) {
                        input.replaceWith(h2);
                    }
                    saveData();
                };

                input.addEventListener('blur', () => finishEditing(true), { once: true });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        finishEditing(true);
                    } else if (e.key === 'Escape') {
                        finishEditing(false);
                    }
                });
            };

            detailsModalSaveBtn.addEventListener('click', () => {
                if (!currentItemElement) return;
                const newStatus = detailsModal.querySelector('input[name="status"]:checked').value;
                const newNote = detailsModalNotes.value.trim();
                currentItemElement.dataset.status = newStatus;
                currentItemElement.dataset.note = newNote;
                const statusElement = currentItemElement.querySelector('.item-status');
                const noteIndicator = currentItemElement.querySelector('.note-indicator');
                const statusType = currentItemElement.dataset.type || 'default';
                const statusClasses = (statusMap[statusType] || statusMap.default)[newStatus];
                statusElement.textContent = newStatus;
                statusElement.className = `item-status text-xs font-medium px-2.5 py-1 rounded-full ${statusClasses}`;
                if (noteIndicator) noteIndicator.classList.toggle('hidden', !newNote);

                if (completedStati.includes(newStatus)) {
                    currentItemElement.classList.add('hidden');
                } else {
                    currentItemElement.classList.remove('hidden');
                }

                saveData();
                closeModal(detailsModal);
            });
            deleteItemBtn.addEventListener('click', () => {
                if (!currentItemElement) return;
                openConfirmModal(`Soll der Eintrag "${currentItemElement.dataset.title}" wirklich gelöscht werden?`, () => {
                    currentItemElement.remove();
                    saveData();
                    closeModal(detailsModal);
                });
            });
            detailsModalNotes.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); detailsModalSaveBtn.click(); } });

            openAddListModalBtn.addEventListener('click', () => openModal(addListModal));
            addListSaveBtn.addEventListener('click', () => {
                const title = newListTitleInput.value.trim();
                if (!title) return;
                const listId = 'list-' + Date.now();
                const newListHTML = `
                <section id="${listId}" class="rounded-2xl p-6 shadow-lg flex flex-col transition-all duration-300 hover:shadow-xl" style="background-color: var(--card-bg); border: 1px solid var(--card-border-color);" data-list-type="default">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold" style="color: var(--header-color);">${title}</h2>
                        <div class="flex items-center gap-1">
                            <button class="add-item-btn p-2 rounded-full" title="Neuer Eintrag" style="color: var(--text-color-light); background-color: var(--item-bg-hover);">
                                <i class="material-icons text-base">add</i>
                            </button>
                            <button class="open-completed-btn p-2 rounded-full" title="Erledigte anzeigen" style="color: var(--text-color-light); background-color: var(--item-bg-hover);">
                                <i class="material-icons text-base">done_all</i>
                            </button>
                            <button class="edit-list-btn p-2 rounded-full" title="Titel bearbeiten" style="color: var(--text-color-light); background-color: var(--item-bg-hover);">
                                <i class="material-icons text-base">edit</i>
                            </button>
                            <button class="delete-list-btn p-2 rounded-full" title="Liste löschen" style="color: var(--text-color-light); background-color: var(--item-bg-hover);">
                                <i class="material-icons text-base">delete</i>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-3 list-none p-0 overflow-y-auto pr-2 item-container" style="max-height: 35rem;"></div>
                </section>`;
                mainGrid.insertAdjacentHTML('beforeend', newListHTML);
                newListTitleInput.value = '';
                saveData();
                closeModal(addListModal);
            });
            newListTitleInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') addListSaveBtn.click(); });

            const handleOpenAddItemModal = (button) => {
                const listSection = button.closest('section');
                currentListContainer = listSection.querySelector('.item-container');
                const listType = listSection.dataset.listType;
                addItemModalTitle.textContent = `Neuen ${listType === 'book' ? 'Buch' : 'Eintrag'} erstellen`;
                addItemForm.innerHTML = '';
                let formFields = '';
                const labelClass = "block mb-2 text-sm";
                const inputClass = "w-full rounded-lg p-2.5";
                const inputStyle = `background-color: var(--input-bg); border: 1px solid var(--input-border-color);`;
                if (listType === 'book') { formFields = `<div><label for="new-item-title" class="${labelClass}" style="color: var(--text-color-light);">Buchtitel</label><input type="text" id="new-item-title" class="${inputClass}" style="${inputStyle}" required></div><div><label for="new-item-subtitle" class="${labelClass}" style="color: var(--text-color-light);">Author</label><input type="text" id="new-item-subtitle" class="${inputClass}" style="${inputStyle}"></div>`; }
                else if (listType === 'media') { formFields = `<div><label for="new-item-title" class="${labelClass}" style="color: var(--text-color-light);">Titel</label><input type="text" id="new-item-title" class="${inputClass}" style="${inputStyle}" required></div><div><label for="new-item-subtitle" class="${labelClass}" style="color: var(--text-color-light);">Typ (Film/Serie)</label><input type="text" id="new-item-subtitle" class="${inputClass}" style="${inputStyle}"></div>`; }
                else { formFields = `<div><label for="new-item-title" class="${labelClass}" style="color: var(--text-color-light);">Titel</label><input type="text" id="new-item-title" class="${inputClass}" style="${inputStyle}" required></div>`; }
                addItemForm.innerHTML = formFields;
                openModal(addItemModal);
            };

            addItemSaveBtn.addEventListener('click', () => {
                if (!currentListContainer) return;
                const listType = currentListContainer.closest('section').dataset.listType;
                const title = addItemForm.querySelector('#new-item-title')?.value.trim();
                const subtitle = addItemForm.querySelector('#new-item-subtitle')?.value.trim() || '';
                if (!title) return;
                const statusType = listType || 'default';
                const initialStatus = Object.keys(statusMap[statusType] || statusMap.default)[2];
                const statusClasses = (statusMap[statusType] || statusMap.default)[initialStatus];
                currentListContainer.insertAdjacentHTML('beforeend', `<div class="list-item p-4 rounded-lg cursor-pointer" style="background-color: var(--item-bg);" onmouseover="this.style.backgroundColor='var(--item-bg-hover)';" onmouseout="this.style.backgroundColor='var(--item-bg)';" data-type="${listType}" data-title="${title}" data-subtitle="${subtitle}" data-status="${initialStatus}" data-note=""><div class="flex items-center"><p class="font-semibold item-title" style="color: var(--header-color);">${title}</p><i class="material-icons text-sm ml-2 note-indicator hidden" style="color: var(--text-color-light);">subject</i></div><p class="text-sm mb-2 item-subtitle" style="color: var(--text-color-light);">${subtitle}</p><span class="item-status text-xs font-medium px-2.5 py-1 rounded-full ${statusClasses}">${initialStatus}</span></div>`);
                addItemForm.reset();
                saveData();
                closeModal(addItemModal);
            });
            addItemForm.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addItemSaveBtn.click(); } });

            // --- IMPORT / EXPORT LOGIC ---
            const gatherDataForExport = () => {
                const lists = [];
                document.querySelectorAll('#main-grid > section:not(#habits)').forEach(section => {
                    const iconEl = section.querySelector('.flex > .material-icons');
                    const listData = {
                        id: section.id,
                        title: section.querySelector('h2').textContent,
                        icon: iconEl ? iconEl.textContent : null,
                        type: section.dataset.listType,
                        items: []
                    };
                    section.querySelectorAll('.list-item').forEach(item => {
                        listData.items.push({
                            title: item.dataset.title,
                            subtitle: item.dataset.subtitle,
                            status: item.dataset.status,
                            note: item.dataset.note
                        });
                    });
                    lists.push(listData);
                });
                return {
                    habits: allHabits,
                    log: dailyLog,
                    lists: lists
                };
            };

            const renderImportedData = (data, showConfirm = true) => {
                const performImport = () => {
                    allHabits = data.habits || [];
                    dailyLog = data.log || {};

                    document.querySelectorAll('#main-grid > section:not(#habits):not(#books):not(#media)').forEach(el => el.remove());
                    document.querySelectorAll('#books .item-container, #media .item-container').forEach(el => el.innerHTML = '');

                    (data.lists || []).forEach(listData => {
                        let section = document.querySelector(`#main-grid section[data-list-type="${listData.type}"]`);
                        if (!section && listData.type !== 'book' && listData.type !== 'media') {
                            const listId = listData.id || 'list-' + Date.now();
                            const newListHTML = `
                            <section id="${listId}" class="rounded-2xl p-6 shadow-lg flex flex-col transition-all duration-300 hover:shadow-xl" style="background-color: var(--card-bg); border: 1px solid var(--card-border-color);" data-list-type="${listData.type}">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-2xl font-bold" style="color: var(--header-color);">${listData.title}</h2>
                                    <div class="flex items-center gap-1">
                                        <button class="add-item-btn p-2 rounded-full" title="Neuer Eintrag" style="color: var(--text-color-light); background-color: var(--item-bg-hover);">
                                            <i class="material-icons text-base">add</i>
                                        </button>
                                        <button class="open-completed-btn p-2 rounded-full" title="Erledigte anzeigen" style="color: var(--text-color-light); background-color: var(--item-bg-hover);">
                                            <i class="material-icons text-base">done_all</i>
                                        </button>
                                        <button class="edit-list-btn p-2 rounded-full" title="Titel bearbeiten" style="color: var(--text-color-light); background-color: var(--item-bg-hover);">
                                            <i class="material-icons text-base">edit</i>
                                        </button>
                                        <button class="delete-list-btn p-2 rounded-full" title="Liste löschen" style="color: var(--text-color-light); background-color: var(--item-bg-hover);">
                                            <i class="material-icons text-base">delete</i>
                                        </button>
                                    </div>
                                </div>
                                <div class="space-y-3 list-none p-0 overflow-y-auto pr-2 item-container" style="max-height: 35rem;"></div>
                            </section>`;
                            mainGrid.insertAdjacentHTML('beforeend', newListHTML);
                            section = mainGrid.lastElementChild;
                        }
                        if (section) {
                            const container = section.querySelector('.item-container');
                            container.innerHTML = '';
                            (listData.items || []).forEach(item => {
                                const statusType = listData.type || 'default';
                                const statusClasses = (statusMap[statusType] || statusMap.default)[item.status];
                                const isCompleted = completedStati.includes(item.status);
                                container.insertAdjacentHTML('beforeend', `<div class="list-item p-4 rounded-lg cursor-pointer ${isCompleted ? 'hidden' : ''}" style="background-color: var(--item-bg);" onmouseover="this.style.backgroundColor='var(--item-bg-hover)';" onmouseout="this.style.backgroundColor='var(--item-bg)';" data-type="${listData.type}" data-title="${item.title}" data-subtitle="${item.subtitle}" data-status="${item.status}" data-note="${item.note}"><div class="flex items-center"><p class="font-semibold item-title" style="color: var(--header-color);">${item.title}</p><i class="material-icons text-sm ml-2 note-indicator ${item.note ? '' : 'hidden'}" style="color: var(--text-color-light);">subject</i></div><p class="text-sm mb-2 item-subtitle" style="color: var(--text-color-light);">${item.subtitle}</p><span class="item-status text-xs font-medium px-2.5 py-1 rounded-full ${statusClasses}">${item.status}</span></div>`);
                            });
                        }
                    });
                    renderAllHabits();
                    saveData();
                };

                if (showConfirm) {
                    openConfirmModal("Möchtest du wirklich importieren? Alle aktuellen Daten werden überschrieben.", performImport);
                } else {
                    performImport();
                }
            };

            exportBtn.addEventListener('click', () => {
                const data = gatherDataForExport();
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'HabitMea_Backup.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            importBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        renderImportedData(importedData, true);
                    } catch (error) {
                        alert("Fehler: Die Datei konnte nicht gelesen werden. Stelle sicher, dass es eine gültige Backup-Datei ist.");
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // Reset file input
            });

            // --- INITIALIZE ---
            loadData();
            renderAllHabits();

            const handleOpenCompletedModal = (button) => {
                const listSection = button.closest('section');
                const listTitle = listSection.querySelector('h2').textContent;
                const items = listSection.querySelectorAll('.list-item');

                completedItemsModalTitle.textContent = `Erledigte Einträge: ${listTitle}`;
                completedItemsList.innerHTML = '';

                let completedCount = 0;
                items.forEach(item => {
                    if (completedStati.includes(item.dataset.status)) {
                        const clonedItem = item.cloneNode(true);
                        clonedItem.classList.remove('hidden');
                        clonedItem.style.cursor = 'pointer';
                        clonedItem.addEventListener('click', () => {
                            closeModal(completedItemsModal);
                            handleOpenDetailsModal(item);
                        });
                        completedItemsList.appendChild(clonedItem);
                        completedCount++;
                    }
                });

                if (completedCount === 0) {
                    completedItemsList.innerHTML = `<p style="color: var(--text-color-light);">Keine erledigten Einträge in dieser Liste.</p>`;
                }

                openModal(completedItemsModal);
            };

            // --- TABLE OF CONTENTS LOGIC ---
            const populateTableOfContents = () => {
                tableOfContentsList.innerHTML = '';
                
                // Add all sections to the table of contents
                document.querySelectorAll('#main-grid > section').forEach(section => {
                    const title = section.querySelector('h2')?.textContent || section.id;
                    const sectionId = section.id;
                    const icon = section.querySelector('.material-icons')?.textContent || '';
                    
                    tableOfContentsList.insertAdjacentHTML('beforeend', `
                        <div class="toc-item p-3 rounded-lg cursor-pointer"
                             style="background-color: var(--item-bg);"
                             onmouseover="this.style.backgroundColor='var(--item-bg-hover)';"
                             onmouseout="this.style.backgroundColor='var(--item-bg)';"
                             data-section-id="${sectionId}">
                            <div class="flex items-center">
                                ${icon ? `<i class="material-icons mr-3" style="color: var(--text-color-light);">${icon}</i>` : ''}
                                <span class="font-semibold" style="color: var(--header-color);">${title}</span>
                            </div>
                        </div>
                    `);
                });
            };
            
            // Handle clicking on a table of contents item
            tableOfContentsList.addEventListener('click', (e) => {
                const tocItem = e.target.closest('.toc-item');
                if (!tocItem) return;
                
                const sectionId = tocItem.dataset.sectionId;
                const section = document.getElementById(sectionId);
                
                if (section) {
                    // Close the modal
                    closeModal(tableOfContentsModal);
                    
                    // Scroll to the section
                    // Scroll to the section
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
            
            // Open table of contents modal when button is clicked
            tableOfContentsBtn.addEventListener('click', () => {
                populateTableOfContents();
                openModal(tableOfContentsModal);
            });

            // --- GLOBAL API & BACKUP/RESTORE INTEGRATION ---
            window.HabitMeaAPI = {
                gatherDataForExport
            };

            window.addEventListener('message', (event) => {
                const { type, data } = event.data;

                if (type === 'backupDataRequest') {
                    const backupData = gatherDataForExport();
                    event.source.postMessage({
                        type: 'backupDataResponse',
                        key: 'habitmea',
                        data: backupData
                    }, event.origin);
                }

                if (type === 'restoreBackupData') {
                    if (data) {
                        try {
                            // Use the robust method from memomea: save to localStorage and reload.
                            localStorage.setItem('habitmea_data', JSON.stringify(data));
                            window.location.reload();
                        } catch (e) {
                            console.error("Error saving restored habitmea data:", e);
                            alert("Fehler beim Wiederherstellen der HabitMea-Daten.");
                        }
                    }
                }

                // Theme handling
                const message = event.data;
                if (typeof message === 'string' && message.startsWith('set-theme-')) {
                    const theme = message.split('-')[2];
                    if (theme === 'light' || theme === 'dark') {
                        document.documentElement.dataset.theme = theme;
                    }
                }
            });
        });
    </script>
</body>

</html>